<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Majorcan Highs: A Trick-Taking Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Light mint background */
        }
        .card {
            width: 80px;
            height: 120px;
            background-color: white;
            border: 3px solid #10b981; /* Emerald border */
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            font-weight: 700;
            font-size: 2rem;
            color: #10b981;
            transition: transform 0.1s, box-shadow 0.1s;
            cursor: pointer;
            user-select: none;
        }
        .card-playable:hover, .card-playable:focus {
            transform: translateY(-5px);
            box-shadow: 0 8px 10px rgba(0, 0, 0, 0.2);
        }
        .card-back {
            background-color: #10b981;
            color: white;
            font-size: 1.5rem;
            line-height: 1.2;
            text-align: center;
            border: 3px solid #065f46;
        }
        .text-red { color: #ef4444; }
        .text-black { color: #1f2937; }

        /* Ensure the main container fills the viewport nicely */
        #game-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Global State Variables (Required for Canvas Environment) -->
    <script type="module">
        // Mandatory dummy variables to satisfy environment requirements
        const __app_id = 'majorcan-highs-game';
        const __firebase_config = '{}';
        const __initial_auth_token = 'dummy-token';
    </script>

    <div id="game-container" class="max-w-xl mx-auto bg-white p-6 rounded-2xl shadow-2xl border-4 border-emerald-600">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-emerald-800">Majorcan Highs üçπ</h1>
            <div class="flex space-x-2">
                <button onclick="renderOptionsScreen()" class="w-10 h-10 bg-gray-300 text-gray-700 font-extrabold rounded-full shadow-lg hover:bg-gray-400 transition duration-150" title="Options">
                    ‚öôÔ∏è
                </button>
                <button onclick="showRulesModal()" class="w-10 h-10 bg-emerald-500 text-white font-extrabold rounded-full shadow-lg hover:bg-emerald-600 transition duration-150" title="Rules">
                    ?
                </button>
            </div>
        </div>
        <div id="score-display" class="flex justify-around text-sm font-semibold mb-4 text-gray-600">
            <!-- Scoreboard will be injected here -->
        </div>

        <!-- Screen Container -->
        <div id="screen-container">
            <!-- Content will be injected here by JavaScript -->
        </div>
    </div>

    <!-- Death Modal (Hidden by default) -->
    <div id="death-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-red-50 p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-100 border-4 border-red-500">
            <h2 id="death-modal-title" class="text-3xl font-extrabold text-red-700 mb-4 text-center">üíÄ The Final Verdict üíÄ</h2>
            <p id="loser-name" class="text-xl font-semibold text-center mb-2"></p>
            <p class="text-lg text-gray-700 mb-4 text-center italic">The card that sealed their fate: <span id="loser-card-rank" class="font-bold text-red-600"></span></p>
            <div class="bg-red-100 p-4 rounded-lg border border-red-300">
                <p id="death-consequence-text" class="text-xl text-gray-800 font-medium leading-relaxed">
                    Comically killed because they: <span id="death-message"></span>
                </p>
            </div>

            <div class="mt-8 flex justify-center">
                <button id="death-modal-action-button" onclick="startNextHand()" class="px-6 py-3 bg-emerald-600 text-white font-bold rounded-lg shadow-lg hover:bg-emerald-700 transition duration-150 transform hover:scale-105">
                    Start Next Hand
                </button>
            </div>
        </div>
    </div>

    <!-- Rules Modal (Hidden by default) -->
    <div id="rules-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300 border-4 border-emerald-600">
            <h2 class="text-3xl font-extrabold text-emerald-800 mb-4 text-center">Majorcan Highs Rules</h2>

            <div class="space-y-4 text-gray-700">
                <h3 class="text-xl font-bold text-emerald-600">Objective & Lives</h3>
                <p>Each player starts with **3 lives**. The last player standing wins the Majorcan Highs championship.</p>

                <h3 class="text-xl font-bold text-emerald-600">Gameplay (The Hand)</h3>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li>Each player is dealt **3 cards**.</li>
                    <li>The hand consists of **${gameSettings.roundsPerHand} rounds (tricks)**.</li>
                    <li>The player who wins a trick leads the next.</li>
                </ul>
                
                <h3 class="text-xl font-bold text-emerald-600">Trick Winning</h3>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li><span class="font-bold">Highest Ranked Card Wins:</span> Ranks are A (Lowest) &rarr; K (Highest).</li>
                    <li><span class="font-bold">Leading Suit Rule (${gameSettings.leadingSuitTrumps ? 'ON' : 'OFF'}):</span> ${gameSettings.leadingSuitTrumps ? 'Only the highest card of the **leading suit** can win the trick. If no card of the leading suit is played, the highest card overall wins.' : 'The highest ranked card wins, regardless of suit.'}</li>
                </ul>

                <h3 class="text-xl font-bold text-emerald-600">Consequences (${gameSettings.consequencesType})</h3>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li>Only the **final trick** matters for lives.</li>
                    <li>The player who plays the **single lowest card** in the final trick loses a life and faces a consequence.</li>
                    <li>If two or more players tie for the lowest card, no one loses a life.</li>
                </ul>

                <h3 class="text-xl font-bold text-emerald-600 mt-6">${gameSettings.consequencesType} by Rank</h3>
                <p class="text-sm italic mb-2">The rank of the losing card determines the fate:</p>
                <div id="rules-consequences-list" class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <!-- Consequences injected here -->
                </div>
            </div>

            <div class="mt-8 flex justify-center">
                <button onclick="hideRulesModal()" class="px-6 py-3 bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition duration-150 transform hover:scale-105">
                    Close Rules
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Core Game Data ---

        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        const SUITS = ['H', 'D', 'C', 'S']; // Hearts, Diamonds, Clubs, Spades
        const SUIT_SYMBOLS = { 'H': '‚ô•', 'D': '‚ô¶', 'C': '‚ô£', 'S': '‚ô†' };
        // Rank value: A=1 (low), K=13 (high)
        const RANK_VALUE = Object.fromEntries(RANKS.map((r, i) => [r, i + 1]));

        // --- Game State & Settings ---

        let players = []; // Includes { id, name, hand, lives: 3 }
        let deck = [];
        let currentTrick = []; // { playerId: id, card: 'KS', playerName: name }
        let currentPlayerIndex = 0;
        let gameState = 'setup'; // 'setup', 'handoff', 'play', 'resolution', 'reveal', 'options'

        let gameSettings = {
            roundsPerHand: 3,
            leadingSuitTrumps: true, // New setting
            consequencesType: 'Comedic Deaths', // 'Comedic Deaths' or 'Mild Inconveniences'
        };

        // Consequences data structure (mutable for editing)
        let CONSEQUENCES = {
            'A': "stumble over their own two feet while attempting to tie their shoes and fall into a tiny sinkhole leading directly to a badger's tea party.",
            '2': "are mistaken for a runaway garden gnome by a precision drone strike.",
            '3': "are swallowed whole by a very bored but highly determined house cat.",
            '4': "accidentally order 400 lbs of mayonnaise instead of coffee and drown in the resulting creamy avalanche.",
            '5': "win a lottery but the celebratory confetti gun misfires, lodging a piece of glitter directly into their brain.",
            '6': "watch their sock puppet achieve sentience and insist on wearing them as a hand-hat until they suffocate from lack of style.",
            '7': "try to fix a leaky faucet but end up summoning a vengeful water spirit who washes them away to the dimension of damp socks.",
            '8': "get hit by a rogue coconut, even though they are indoors in a desert.",
            '9': "die of embarrassment after realizing they've spent all day talking to a mannequin they thought was a cool new friend.",
            '10': "are engulfed by a rogue wave of Majorcan Highs cocktails that washes them out to sea, only to be pecked to death by synchronized seagulls.",
            'J': "get fatally entangled in a very enthusiastic game of Twister being played by professional acrobats.",
            'Q': "choke on a meticulously crafted, artisanal crouton.",
            'K': "are judged by a flock of pigeons for having 'too much main character energy' and are subsequently dive-bombed by bird droppings until they lose consciousness and fall off a small stool."
        };
        
        const INCONVENIENCES = {
            'A': "have to wear their shirt backwards for the next 24 hours.",
            '2': "must refer to all body parts by the wrong name for one hour.",
            '3': "have to eat a spoonful of plain mustard.",
            '4': "must sing the alphabet every time they enter a room today.",
            '5': "must use only thumbs to text for the next 30 minutes.",
            '6': "have to call a random contact and speak entirely in rhyming couplets.",
            '7': "must refer to themselves in the third person for the rest of the game.",
            '8': "have to post an extremely awkward photo of themselves on social media (private story allowed).",
            '9': "must do 10 push-ups right now.",
            '10': "have to whisper all their communication until the next hand is dealt.",
            'J': "must surrender their phone to another player for 5 minutes.",
            'Q': "must eat any single food item determined by the winner of the next trick.",
            'K': "have to switch seats with another player who must then point and laugh at them for 1 minute."
        };

        // Initialize consequences with the default comedic deaths
        function initializeConsequences() {
            // Check if we need to load the alternate list for display in the editor
            if (Object.keys(CONSEQUENCES).length < 13) {
                 CONSEQUENCES = {...COMEDIC_DEATHS}; // Fallback for initial load
            }
        }
        
        // --- Utility Functions ---

        /**
         * Creates a full deck of 52 cards (e.g., 'AH', 'KD', '2C', etc.)
         * @returns {string[]} The shuffled deck.
         */
        function createAndShuffleDeck() {
            let newDeck = [];
            for (const suit of SUITS) {
                for (const rank of RANKS) {
                    newDeck.push(rank + suit);
                }
            }
            // Fisher-Yates shuffle
            for (let i = newDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newDeck[i], newDeck[j]] = [newDeck[j], newDeck[i]];
            }
            return newDeck;
        }

        /**
         * Extracts the rank from a card string.
         * @param {string} card e.g., 'KH'
         * @returns {string} e.g., 'K'
         */
        function getRank(card) {
            return card.slice(0, -1);
        }

        /**
         * Parses a card string into rank and suit.
         * @param {string} card e.g., 'KH'
         * @returns {{rank: string, suit: string, value: number, colorClass: string}}
         */
        function parseCard(card) {
            const rank = getRank(card);
            const suit = card.slice(-1);
            const value = RANK_VALUE[rank];
            const colorClass = (suit === 'H' || suit === 'D') ? 'text-red' : 'text-black';
            return { rank, suit, value, colorClass };
        }
        
        // --- Modal Control Functions ---

        function showRulesModal() {
            // Update the rules content dynamically based on current settings
            document.getElementById('rules-modal').querySelector('.max-w-lg').innerHTML = `
                <h2 class="text-3xl font-extrabold text-emerald-800 mb-4 text-center">Majorcan Highs Rules</h2>
                <div class="space-y-4 text-gray-700">
                    <h3 class="text-xl font-bold text-emerald-600">Objective & Lives</h3>
                    <p>Each player starts with **3 lives**. The last player standing wins the Majorcan Highs championship.</p>

                    <h3 class="text-xl font-bold text-emerald-600">Gameplay (The Hand)</h3>
                    <ul class="list-disc list-inside space-y-1 ml-4">
                        <li>Each player is dealt **3 cards**.</li>
                        <li>The hand consists of **${gameSettings.roundsPerHand} rounds (tricks)**.</li>
                        <li>The player who wins a trick leads the next.</li>
                    </ul>
                    
                    <h3 class="text-xl font-bold text-emerald-600">Trick Winning</h3>
                    <ul class="list-disc list-inside space-y-1 ml-4">
                        <li><span class="font-bold">Highest Ranked Card Wins:</span> Ranks are A (Lowest) &rarr; K (Highest).</li>
                        <li><span class="font-bold">Leading Suit Rule (${gameSettings.leadingSuitTrumps ? 'ON' : 'OFF'}):</span> ${gameSettings.leadingSuitTrumps ? 'Only the highest card of the **leading suit** can win the trick. If no card of the leading suit is played, the highest card overall wins.' : 'The highest ranked card wins, regardless of suit.'}</li>
                    </ul>

                    <h3 class="text-xl font-bold text-emerald-600">Consequences (${gameSettings.consequencesType})</h3>
                    <ul class="list-disc list-inside space-y-1 ml-4">
                        <li>Only the **final trick** matters for lives.</li>
                        <li>The player who plays the **single lowest card** in the final trick loses a life and faces a consequence.</li>
                        <li>If two or more players tie for the lowest card, no one loses a life.</li>
                    </ul>

                    <h3 class="text-xl font-bold text-emerald-600 mt-6">${gameSettings.consequencesType} by Rank</h3>
                    <p class="text-sm italic mb-2">The rank of the losing card determines the fate:</p>
                    <div id="rules-consequences-list" class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        ${RANKS.map(rank =>
                            `<div class="font-medium">**${rank}**:</div><div>${CONSEQUENCES[rank]}</div>`
                        ).join('')}
                    </div>
                </div>

                <div class="mt-8 flex justify-center">
                    <button onclick="hideRulesModal()" class="px-6 py-3 bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition duration-150 transform hover:scale-105">
                        Close Rules
                    </button>
                </div>
            `;
            document.getElementById('rules-modal').classList.remove('hidden');
        }

        function hideRulesModal() {
            document.getElementById('rules-modal').classList.add('hidden');
        }


        // --- UI Rendering Functions ---

        /**
         * Renders the current scores/lives of all active players.
         */
        function renderScoreDisplay() {
            const scoreDisplay = document.getElementById('score-display');
            scoreDisplay.innerHTML = players.map(p => `
                <div class="text-center p-2 rounded-lg ${p.lives === 0 ? 'bg-red-200 line-through' : 'bg-emerald-100'}">
                    <span class="font-extrabold text-emerald-900">${p.name}:</span>
                    <span class="text-xl font-bold text-red-600">${'‚ù§Ô∏è'.repeat(p.lives)}</span>
                </div>
            `).join('');
        }
        
        function renderOptionsScreen() {
            gameState = 'options';
            const screen = document.getElementById('screen-container');

            screen.innerHTML = `
                <h2 class="text-3xl font-bold text-emerald-800 mb-6 text-center">Game Options</h2>
                <div class="space-y-6">
                    <!-- General Settings -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-md border-b-2 border-emerald-300">
                        <h3 class="text-xl font-bold text-emerald-600 mb-3">General Rules</h3>
                        
                        <label class="block mb-4">
                            <span class="text-gray-700 font-semibold">Rounds (Tricks) per Hand:</span>
                            <input type="number" id="rounds-per-hand" min="1" value="${gameSettings.roundsPerHand}" 
                                   onchange="updateSetting('roundsPerHand', parseInt(this.value))"
                                   class="mt-1 p-2 w-full border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500">
                        </label>

                        <div class="flex items-center justify-between p-2 bg-white rounded-lg border">
                            <span class="text-gray-700 font-semibold">Leading Suit Trumps:</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="leading-suit-trumps" ${gameSettings.leadingSuitTrumps ? 'checked' : ''} 
                                       onchange="updateSetting('leadingSuitTrumps', this.checked)" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                                <span class="ms-3 text-sm font-medium text-gray-900">${gameSettings.leadingSuitTrumps ? 'ON' : 'OFF'}</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Consequences Editor -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-md border-b-2 border-red-300">
                        <h3 class="text-xl font-bold text-red-600 mb-3">Consequences Settings</h3>

                        <div class="flex items-center justify-between p-2 mb-4 bg-white rounded-lg border">
                            <span class="text-gray-700 font-semibold">Consequence Type:</span>
                            <select id="consequences-type" onchange="updateConsequencesType(this.value)" class="p-2 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-red-500">
                                <option value="Comedic Deaths" ${gameSettings.consequencesType === 'Comedic Deaths' ? 'selected' : ''}>Comedic Deaths</option>
                                <option value="Mild Inconveniences" ${gameSettings.consequencesType === 'Mild Inconveniences' ? 'selected' : ''}>Mild Inconveniences</option>
                            </select>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-3 font-medium">Click on any rank to edit the consequence message:</p>
                        <div id="consequences-editor" class="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto pr-2">
                            ${RANKS.map(rank => `
                                <div class="flex items-center p-2 bg-white border rounded-lg cursor-pointer hover:bg-yellow-50 transition duration-100" 
                                     onclick="editConsequence('${rank}')">
                                    <span class="font-extrabold text-lg text-red-500 mr-2">${rank}:</span>
                                    <span id="consequence-text-${rank}" class="text-sm truncate">${CONSEQUENCES[rank]}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <button onclick="renderSetupScreen()" class="w-full px-6 py-3 bg-emerald-600 text-white font-bold text-xl rounded-lg shadow-xl hover:bg-emerald-700 transition duration-150 transform hover:scale-105">
                        Back to Setup
                    </button>
                </div>
            `;
        }
        
        function updateSetting(key, value) {
            if (key === 'roundsPerHand' && value < 1) {
                value = 1;
                document.getElementById('rounds-per-hand').value = 1;
            }
            gameSettings[key] = value;
            // Re-render the options screen to update any visual toggles (like ON/OFF text)
            if (gameState === 'options') {
                renderOptionsScreen();
            }
        }
        
        function updateConsequencesType(type) {
            gameSettings.consequencesType = type;
            // Load the appropriate set for editing/display
            CONSEQUENCES = (type === 'Comedic Deaths') ? {
                'A': "stumble over their own two feet while attempting to tie their shoes and fall into a tiny sinkhole leading directly to a badger's tea party.",
                '2': "are mistaken for a runaway garden gnome by a precision drone strike.",
                '3': "are swallowed whole by a very bored but highly determined house cat.",
                '4': "accidentally order 400 lbs of mayonnaise instead of coffee and drown in the resulting creamy avalanche.",
                '5': "win a lottery but the celebratory confetti gun misfires, lodging a piece of glitter directly into their brain.",
                '6': "watch their sock puppet achieve sentience and insist on wearing them as a hand-hat until they suffocate from lack of style.",
                '7': "try to fix a leaky faucet but end up summoning a vengeful water spirit who washes them away to the dimension of damp socks.",
                '8': "get hit by a rogue coconut, even though they are indoors in a desert.",
                '9': "die of embarrassment after realizing they've spent all day talking to a mannequin they thought was a cool new friend.",
                '10': "are engulfed by a rogue wave of Majorcan Highs cocktails that washes them out to sea, only to be pecked to death by synchronized seagulls.",
                'J': "get fatally entangled in a very enthusiastic game of Twister being played by professional acrobats.",
                'Q': "choke on a meticulously crafted, artisanal crouton.",
                'K': "are judged by a flock of pigeons for having 'too much main character energy' and are subsequently dive-bombed by bird droppings until they lose consciousness and fall off a small stool."
            } : INCONVENIENCES;
            renderOptionsScreen(); // Re-render to show new editable text
        }

        function editConsequence(rank) {
            const currentText = CONSEQUENCES[rank];
            const newText = prompt(`Edit consequence for rank ${rank} (${gameSettings.consequencesType}):`, currentText);
            
            if (newText !== null && newText.trim() !== '') {
                CONSEQUENCES[rank] = newText.trim();
                document.getElementById(`consequence-text-${rank}`).textContent = newText.trim();
                // Persist the consequence set for the current type
                // (In a real app, this would save to local storage/DB)
            }
        }

        /**
         * Renders a single card element.
         */
        function renderCard(cardString, isPlayable = false, type = 'face') {
            if (type === 'back') {
                return `
                    <div class="card card-back flex items-center justify-center p-2">
                        <span class="text-3xl transform rotate-12">üå¥</span>
                        <span class="text-sm font-light uppercase">Highs</span>
                    </div>
                `;
            }

            const { rank, suit, colorClass } = parseCard(cardString);
            const symbol = SUIT_SYMBOLS[suit];
            const playableClass = isPlayable ? 'card-playable bg-yellow-50 shadow-md cursor-pointer' : 'opacity-80';

            return `
                <div onclick="${isPlayable ? `handleCardPlay('${cardString}')` : ''}"
                     class="card ${playableClass} ${colorClass} transition duration-150 ease-in-out">
                    <span class="text-xl self-start leading-none">${rank}</span>
                    <span class="text-4xl sm:text-5xl leading-none">${symbol}</span>
                    <span class="text-xl self-end leading-none transform rotate-180">${rank}</span>
                </div>
            `;
        }

        function renderSetupScreen() {
            gameState = 'setup';
            const screen = document.getElementById('screen-container');
            document.getElementById('score-display').innerHTML = ''; // Clear scores on setup

            screen.innerHTML = `
                <div class="text-center space-y-6">
                    <p class="text-lg text-gray-600">Each player starts with **3 lives**. The hand consists of **${gameSettings.roundsPerHand}** rounds.</p>
                    <div id="player-inputs" class="space-y-4">
                        <input type="text" id="player-1" placeholder="Player 1 Name (Mandatory)" class="p-3 w-full border-2 border-emerald-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500">
                        <input type="text" id="player-2" placeholder="Player 2 Name (Mandatory)" class="p-3 w-full border-2 border-emerald-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500">
                        <input type="text" id="player-3" placeholder="Player 3 Name (Optional)" class="p-3 w-full border-2 border-emerald-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500">
                        <input type="text" id="player-4" placeholder="Player 4 Name (Optional)" class="p-3 w-full border-2 border-emerald-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500">
                    </div>
                    <button onclick="startGame()" class="w-full px-6 py-3 bg-emerald-600 text-white font-bold text-xl rounded-lg shadow-xl hover:bg-emerald-700 transition duration-150 transform hover:scale-105">
                        Start Game!
                    </button>
                    <p id="setup-error" class="text-red-500 font-semibold mt-4 hidden"></p>
                </div>
            `;
        }

        function renderHandOffScreen() {
            gameState = 'handoff';
            const activePlayers = players.filter(p => p.lives > 0);
            
            // If the current player has 0 lives, find the next active player index
            let activePlayerFound = false;
            let originalIndex = currentPlayerIndex;
            
            for (let i = 0; i < players.length; i++) {
                let nextIndex = (originalIndex + i) % players.length;
                if (players[nextIndex].lives > 0) {
                    currentPlayerIndex = nextIndex;
                    activePlayerFound = true;
                    break;
                }
            }

            if (!activePlayerFound) {
                 // Should only happen if remainingPlayers.length <= 1, which should be caught by startNextHand
                renderFinalMessage("An error occurred: No active players found.");
                return;
            }

            const currentPlayer = players[currentPlayerIndex];
            const screen = document.getElementById('screen-container');
            screen.innerHTML = `
                <div class="text-center space-y-8 p-8 bg-emerald-100 rounded-lg border-2 border-emerald-400">
                    <h2 class="text-2xl sm:text-3xl font-bold text-emerald-800">Pass the Phone!</h2>
                    <p class="text-4xl sm:text-5xl font-extrabold text-emerald-600 uppercase tracking-widest">${currentPlayer.name}</p>
                    <p class="text-lg text-gray-700">It's your turn, ${currentPlayer.name}. Please confirm you are ready.</p>
                    <button onclick="renderPlayScreen()" class="w-full px-6 py-4 bg-emerald-600 text-white font-bold text-xl rounded-lg shadow-xl hover:bg-emerald-700 transition duration-150 transform hover:scale-105">
                        View My Hand & Play
                    </button>
                    <p class="text-sm text-gray-500 mt-4">Other players: Turn away!</p>
                </div>
            `;
        }

        function renderPlayScreen() {
            gameState = 'play';
            const currentPlayer = players[currentPlayerIndex];
            const screen = document.getElementById('screen-container');
            const activePlayersCount = players.filter(p => p.lives > 0).length;

            screen.innerHTML = `
                <h2 class="text-2xl font-bold text-emerald-700 mb-4 text-center">Round ${roundNumber} of ${gameSettings.roundsPerHand}</h2>
                <div class="flex justify-between items-center mb-6 p-3 bg-emerald-50 rounded-lg border-b-2 border-emerald-200">
                    <p class="text-lg font-semibold text-gray-700">Playing Now:</p>
                    <p class="text-3xl font-extrabold text-emerald-800">${currentPlayer.name}</p>
                </div>

                <!-- Played Cards (Trick Pile) -->
                <div class="mb-8 p-4 bg-gray-100 rounded-xl shadow-inner">
                    <h3 class="text-xl font-bold text-gray-700 mb-3 text-center">The Trick Pile (${currentTrick.length}/${activePlayersCount})</h3>
                    <div id="trick-pile" class="flex justify-center space-x-2 h-32">
                        ${currentTrick.map(trickItem => renderCard(trickItem.card)).join('')}
                        ${Array(activePlayersCount - currentTrick.length).fill(0).map(() => renderCard('', false, 'back')).join('')}
                    </div>
                </div>

                <!-- Current Player's Hand -->
                <div class="p-4 bg-emerald-200 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold text-emerald-800 mb-3 text-center">Your Hand (${currentPlayer.hand.length} Cards)</h3>
                    <div class="flex justify-center space-x-4">
                        ${currentPlayer.hand.map(card => renderCard(card, true)).join('')}
                    </div>
                    <p class="text-center text-sm text-emerald-800 mt-2 font-medium">Click a card to play it!</p>
                </div>
            `;
        }
        
        /**
         * Renders the screen showing the result of the completed trick.
         * @param {Object} winner The trick item of the player who won.
         * @param {Object|null} loser The trick item of the player who played the lowest unique card, or null.
         */
        function renderTrickResolutionScreen(winner, loser) {
            gameState = 'resolution';
            const screen = document.getElementById('screen-container');

            let announcement = '';
            let subtext = '';
            let buttonText = '';
            let buttonAction = '';
            let highlightClass = 'bg-yellow-100 border-yellow-400 text-yellow-800';

            if (roundNumber < gameSettings.roundsPerHand) {
                // Regular trick resolution
                announcement = `${winner.playerName} takes the trick! üéâ`;
                subtext = `Round ${roundNumber} complete. ${winner.playerName} will lead Round ${roundNumber + 1}.`;
                buttonText = 'Continue to Next Player';
                buttonAction = `startNewRound('${winner.playerId}')`;
            } else {
                // Final trick resolution
                if (loser) {
                    highlightClass = 'bg-red-100 border-red-500 text-red-800';
                    announcement = `${loser.playerName} played the lowest card! üíÄ`;
                    subtext = `Their card (${getRank(loser.card)}) determines the ${gameSettings.consequencesType} for this hand!`;
                    buttonText = 'Reveal the Consequence!';
                    buttonAction = `resolveFinalRound('${loser.playerId}', '${getRank(loser.card)}')`;
                } else {
                    highlightClass = 'bg-green-100 border-green-500 text-green-800';
                    announcement = `No unique lowest card! Everyone lives (for now).`;
                    subtext = `${winner.playerName} still wins the final trick. The next hand begins without a consequence.`;
                    buttonText = 'Start Next Hand';
                    buttonAction = `startNextHand()`;
                }
            }

            // Clear the current trick pile from display before showing the resolution.
            const playedCardsHtml = currentTrick.map(trickItem => renderCard(trickItem.card)).join('');
            currentTrick = []; // Clear the pile state now.

            screen.innerHTML = `
                <h2 class="text-2xl font-bold text-emerald-700 mb-4 text-center">Round ${roundNumber} Concluded</h2>

                <!-- Played Cards -->
                <div class="mb-8 p-4 bg-gray-100 rounded-xl shadow-inner">
                    <h3 class="text-xl font-bold text-gray-700 mb-3 text-center">Cards Played</h3>
                    <div class="flex justify-center space-x-2 h-32">
                        ${playedCardsHtml}
                    </div>
                </div>

                <div class="text-center space-y-4 p-6 rounded-lg border-2 ${highlightClass}">
                    <p class="text-3xl font-extrabold">${announcement}</p>
                    <p class="text-lg text-gray-700">${subtext}</p>
                </div>

                <div class="mt-8 flex justify-center">
                    <button onclick="${buttonAction}" class="px-6 py-4 bg-emerald-600 text-white font-bold text-xl rounded-lg shadow-xl hover:bg-emerald-700 transition duration-150 transform hover:scale-105">
                        ${buttonText}
                    </button>
                </div>
            `;
        }


        // --- Game Logic Functions ---

        /**
         * Initializes the game state, deals cards, and moves to the hand-off screen.
         */
        function startGame() {
            const playerNames = [];
            for (let i = 1; i <= 4; i++) {
                const name = document.getElementById(`player-${i}`).value.trim();
                if (name) {
                    playerNames.push(name);
                }
            }

            if (playerNames.length < 2) {
                const error = document.getElementById('setup-error');
                error.textContent = "Please enter names for at least two players.";
                error.classList.remove('hidden');
                return;
            } else {
                document.getElementById('setup-error').classList.add('hidden');
            }

            // Reset game state
            players = playerNames.map((name, index) => ({
                id: crypto.randomUUID(),
                name: name,
                hand: [],
                lives: 3 // Start with 3 lives
            }));
            deck = createAndShuffleDeck();
            currentTrick = [];
            currentPlayerIndex = 0;
            roundNumber = 1;

            dealCards(3); // Deal 3 cards to each player
            renderScoreDisplay();
            renderHandOffScreen();
        }

        /**
         * Deals a specified number of cards to each player from the deck.
         * @param {number} count The number of cards to deal per player.
         */
        function dealCards(count) {
            // Only deal to players with lives > 0
            const activePlayers = players.filter(p => p.lives > 0);
            for (let c = 0; c < count; c++) {
                for (let p = 0; p < activePlayers.length; p++) {
                    const playerIndex = players.findIndex(pl => pl.id === activePlayers[p].id);
                    if (deck.length > 0) {
                        players[playerIndex].hand.push(deck.pop());
                    }
                }
            }
        }

        /**
         * Handles the click event for playing a card.
         * @param {string} card The card string (e.g., 'KH') that was played.
         */
        function handleCardPlay(card) {
            if (gameState !== 'play') return;

            const currentPlayer = players[currentPlayerIndex];

            // 1. Remove card from hand
            currentPlayer.hand = currentPlayer.hand.filter(c => c !== card);

            // 2. Add card to the trick pile
            currentTrick.push({ playerId: currentPlayer.id, card: card, playerName: currentPlayer.name });

            // 3. Check if trick is complete
            const activePlayersCount = players.filter(p => p.lives > 0).length;
            if (currentTrick.length === activePlayersCount) {
                resolveTrick();
            } else {
                // 4. Advance to the next ACTIVE player
                let nextPlayerIndex;
                let foundNext = false;
                
                // Search for the next active player, wrapping around
                for (let i = 1; i <= players.length; i++) {
                    nextPlayerIndex = (currentPlayerIndex + i) % players.length;
                    // FIX: Changed nextIndex to nextPlayerIndex
                    if (players[nextPlayerIndex].lives > 0) { 
                        currentPlayerIndex = nextPlayerIndex; // FIX: Changed nextIndex to nextPlayerIndex
                        foundNext = true;
                        break;
                    }
                }

                if(foundNext) {
                    renderHandOffScreen();
                } else {
                    console.error("Could not find next active player.");
                }
            }
        }

        /**
         * Determines the winner and loser of the current trick and renders the resolution screen.
         */
        function resolveTrick() {
            // Find the losing card (lowest overall)
            let losingCard = currentTrick.reduce((best, current) => 
                parseCard(current.card).value < parseCard(best.card).value ? current : best, currentTrick[0]);
            
            // Check for Loser (Lowest Card) - Check if there's a tie for the lowest card.
            const lowestValue = parseCard(losingCard.card).value;
            const lowestPlayers = currentTrick.filter(item => parseCard(item.card).value === lowestValue);
            const loser = (lowestPlayers.length === 1) ? losingCard : null;


            // --- Determine WINNER (Highest Card) based on game setting ---
            let winningCard = currentTrick[0];
            
            if (gameSettings.leadingSuitTrumps) {
                const leadingCard = currentTrick[0];
                const leadingSuit = parseCard(leadingCard.card).suit;

                // 1. Find the highest card that matches the leading suit
                let leadingSuitCandidates = currentTrick.filter(item => parseCard(item.card).suit === leadingSuit);

                if (leadingSuitCandidates.length > 0) {
                    // Highest card of the leading suit wins.
                    winningCard = leadingSuitCandidates.reduce((best, current) => 
                        parseCard(current.card).value > parseCard(best.card).value ? current : best, leadingSuitCandidates[0]);
                } else {
                    // If nobody followed the leading suit, the highest overall card wins (as per the non-trumping rule)
                    winningCard = currentTrick.reduce((best, current) => 
                        parseCard(current.card).value > parseCard(best.card).value ? current : best, currentTrick[0]);
                }
            } else {
                // Old rule: Highest rank overall wins, regardless of suit.
                winningCard = currentTrick.reduce((best, current) => 
                    parseCard(current.card).value > parseCard(best.card).value ? current : best, currentTrick[0]);
            }
            
            renderTrickResolutionScreen(winningCard, loser);
        }

        /**
         * Prepares for the next round (trick) within the same hand.
         * @param {string} winnerId The ID of the player who won the trick.
         */
        function startNewRound(winnerId) {
            // 1. Increment round number
            roundNumber++;

            // 2. Set the winner of the last trick to start the next round
            const winningPlayerIndex = players.findIndex(p => p.id === winnerId);
            currentPlayerIndex = winningPlayerIndex;

            // 3. Go to the next player's hand-off screen
            renderHandOffScreen();
        }

        /**
         * Resolves the outcome of the final round (trick), including life loss.
         * @param {string} loserId ID of the player who lost the round.
         * @param {string} rank Rank of the card that caused the loss.
         */
        function resolveFinalRound(loserId, rank) {
            const loser = players.find(p => p.id === loserId);

            if (loser) {
                // Player loses a life
                loser.lives -= 1;
                renderScoreDisplay(); // Update scores immediately

                // Show the death modal
                showDeathModal(loser, rank);
            }
        }
        
        /**
         * Starts a new hand (new deal, new rounds).
         */
        function startNextHand() {
            document.getElementById('death-modal').classList.add('hidden');
            
            // Check if only one player remains before dealing.
            const remainingPlayers = players.filter(p => p.lives > 0);
            if (remainingPlayers.length <= 1) {
                // If the loser just lost their last life, the modal must handle the WINNER declaration.
                // We should only reach here if the modal's action button was clicked after a death.
                if (remainingPlayers.length === 1) {
                    renderFinalMessage(`${remainingPlayers[0].name} is the MAJORCAN HIGH WINNER!`);
                } else {
                    renderFinalMessage("The game ended with no winner (all players eliminated in the same final round).");
                }
                return;
            }

            // Re-deal and reset for a new hand
            deck = createAndShuffleDeck();
            currentTrick = [];
            roundNumber = 1;
            
            // Set first player of the new hand to the next active player after the person who lost a life (or the first person in the array if the loser was the last one).
            const nextActivePlayerIndex = players.findIndex(p => p.lives > 0);
            currentPlayerIndex = nextActivePlayerIndex !== -1 ? nextActivePlayerIndex : 0;

            dealCards(3);
            renderScoreDisplay();
            renderHandOffScreen();
        }

        /**
         * Displays the comedic death modal for the player who lost the round.
         * @param {Object} loserPlayer The player object of the loser.
         * @param {string} rank The rank of the losing card.
         */
        function showDeathModal(loserPlayer, rank) {
            gameState = 'reveal';
            const deathMessage = CONSEQUENCES[rank];
            const consequenceType = gameSettings.consequencesType;

            const remainingPlayers = players.filter(p => p.lives > 0);
            let buttonText = '';
            let buttonAction = '';
            let consequenceIntro = '';

            if (loserPlayer.lives <= 0) {
                // Player is eliminated
                const winner = remainingPlayers[0] || null;
                const winnerName = winner ? winner.name : 'No one';
                
                document.getElementById('death-modal-title').textContent = 'üëë Majorcan High Winner! üëë';
                document.getElementById('loser-name').textContent = `${loserPlayer.name} has run out of lives and is ELIMINATED!`;
                document.getElementById('loser-card-rank').textContent = '';

                if (remainingPlayers.length <= 0) {
                    // Total elimination (Should be rare)
                    consequenceIntro = `The final card (${rank}) caused a simultaneous elimination! The game ends in a draw.`;
                    buttonText = 'Start New Game';
                    buttonAction = 'restartGame()';
                } else {
                    // Clear winner
                    consequenceIntro = `The Majorcan High Winner is ${winnerName}!`;
                    buttonText = 'Start New Game';
                    buttonAction = 'restartGame()';
                }
                
                document.getElementById('death-consequence-text').innerHTML = `
                    <p class="text-xl text-gray-800 font-medium leading-relaxed">${consequenceIntro}</p>
                `;


            } else {
                // Continue to next hand
                document.getElementById('death-modal-title').textContent = (consequenceType === 'Comedic Deaths') ? 'üíÄ The Final Verdict üíÄ' : '‚ö†Ô∏è Mild Inconvenience ‚ö†Ô∏è';
                document.getElementById('loser-name').textContent = `${loserPlayer.name} has lost a life! Lives remaining: ${'‚ù§Ô∏è'.repeat(loserPlayer.lives)}`;
                document.getElementById('loser-card-rank').textContent = `${rank}`;
                
                // Update the text to flow grammatically:
                consequenceIntro = (consequenceType === 'Comedic Deaths') ? 
                    'Comically killed because they:' : 
                    'Faced a mild inconvenience and must:';

                document.getElementById('death-consequence-text').innerHTML = `
                    <p class="text-xl text-gray-800 font-medium leading-relaxed">${consequenceIntro} <span id="death-message">${deathMessage}</span></p>
                `;

                buttonText = 'Start Next Hand';
                buttonAction = 'startNextHand()';
            }

            document.getElementById('death-modal-action-button').textContent = buttonText;
            document.getElementById('death-modal-action-button').onclick = window[buttonAction] || new Function(buttonAction);

            document.getElementById('death-modal').classList.remove('hidden');
        }


        /**
         * Renders the final message for the Majorcan High Winner.
         */
        function renderFinalMessage(message) {
            const screen = document.getElementById('screen-container');
            screen.innerHTML = `
                <div class="text-center space-y-6 p-8 bg-emerald-100 rounded-lg border-2 border-emerald-400">
                    <h2 class="text-3xl font-bold text-emerald-800">GAME OVER!</h2>
                    <p class="text-4xl font-extrabold text-emerald-600">${message}</p>
                    <button onclick="restartGame()" class="w-full px-6 py-3 bg-emerald-600 text-white font-bold text-xl rounded-lg shadow-xl hover:bg-emerald-700 transition duration-150 transform hover:scale-105">
                        Play Again
                    </button>
                </div>
            `;
             document.getElementById('score-display').innerHTML = '';
        }
        
        /**
         * Restarts the entire game.
         */
        function restartGame() {
            document.getElementById('death-modal').classList.add('hidden');
            renderSetupScreen();
        }

        // --- Initialization ---

        // Start the application on the setup screen
        window.onload = function() {
            initializeConsequences();
            renderSetupScreen();
        };

        // Expose functions globally for HTML event handlers
        window.startGame = startGame;
        window.renderPlayScreen = renderPlayScreen;
        window.handleCardPlay = handleCardPlay;
        window.restartGame = restartGame;
        window.resolveFinalRound = resolveFinalRound;
        window.startNextHand = startNextHand;
        window.showRulesModal = showRulesModal;
        window.hideRulesModal = hideRulesModal;
        window.renderOptionsScreen = renderOptionsScreen;
        window.updateSetting = updateSetting;
        window.updateConsequencesType = updateConsequencesType;
        window.editConsequence = editConsequence;
        window.startNewRound = startNewRound; // Added missing global expose
    </script>
</body>
</html>
