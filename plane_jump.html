<!DOCTYPE html>
<html>
    <head>
        <script src="//cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser.min.js"></script>
    </head>
    <body>
        <div id="game"></div>
        <script>
// example from https://www.thepolyglotdeveloper.com/2020/09/include-touch-cursor-gesture-events-phaser-game/
/*
            const phaserConfig = {
                type: Phaser.AUTO,
                parent: "game",
                width: 1280,
                height: 720,
                backgroundColor: "#5DACD8",
                scene: {
                    init: initScene,
                    preload: preloadScene,
                    create: createScene,
                    update: updateScene
                }
            }; 
  */          

  //from  https://rexrainbow.github.io/phaser3-rex-notes/docs/site/game/#configuration
 // something added

            const phaserConfig = {
                type: Phaser.AUTO,
                parent: 'game',
                // 750x1334
                // 2560Ã—1440
                width: 600,
                height: 800,
                //width: 1440,
                //height: 2560,
                scale: {
                    mode: Phaser.Scale.FIT,
                    autoCenter: Phaser.Scale.CENTER_BOTH
                },
                dom: {
                    createContainer: false,
                },
                scene: 'scene_01',
                backgroundColor: 0x333333,
                transparent: true,
                scene: {
                    init: initScene,
                    preload: preloadScene,
                    create: createScene,
                    update: updateScene
                }            
            }

            const game = new Phaser.Game(phaserConfig);

            //var game = new Phaser.Game(config);


            var isClicking = false;
            var swipeDirection;
            var touchAlpha = 0.5;
            var touchAlphaChange = -0.1;
            var x2 =0;
            var y2 =0;
            var x1 =0;
            var y1 =0;

            var matrixWidth = 10;
            var playWidth = 8;

            
            widthText = game.config.width/matrixWidth;
            heightText = widthText

            
            // text offset x & y 
            var widthOffset = widthText * 0.2;
            var heightOffset = heightText *-0.1;


            var textConfig={fontSize:widthText,color:'#555555',fontFamily: 'monospace'};
            var textStatusConfig={fontSize:widthText/2,color:'#555555',fontFamily: 'monospace'};


            console.log ( widthOffset,  heightOffset);

            // user input info
            var userState = 'ready'
            var xShift = 0;
            var yShift = 0;

            // setup matrices
            var totalLevels = 5;
            var level = 0;
            var wordID = 0;
            var levelWordList = new Array(totalLevels);
            levelWordList[0] = ["blob", "slob", "globe", "best", "sore", "port"];
            levelWordList[1] = ["kitchen", "red", "apples", "motion", "park", "crunch"];
            levelWordList[2] = ["to", "be", "or", "not", "to", "be", "that", "is", "the", "question"];
            levelWordList[3] = ["Neither", "a", "borrower", "nor", "a", "lender", "be"];
            levelWordList[4] = ["The", "lady", "doth", "protest", "too", "much", "methinks"];
            levelWordList[5] = ["Do", "you", "think", "I", "am", "easier", "to", "be", "played", "on", "than", "a", "pipe?"]
            levelWordList[5] = ["evil", "live", "veil", "vile"];

            var levelWordMinScore = new Array(totalLevels);
            levelWordMinScore = [9, 5, 10, 7, 3, 6];
            var score = 0;
            var totalScore = 0;

            var wordColor = ["white", "grey", "blue", "green", "yellow", "orange", "orangered", "red"];
            var phase = "frontScreen"; //frontScreen , readyForLevel, levelSetUp, level,   
            var wordListLen = levelWordList[0].length;
            var lastTime = 100;

            var matrixSize = 8;

            var landscape = null; // this will be our graphics object on create

            


            var displayMatrix =new Array(matrixSize); //  this will be our text matrix on create
            displayMatrix[0] = new Array(matrixSize);
            displayMatrix[1] = new Array(matrixSize);
            displayMatrix[2] = new Array(matrixSize);
            displayMatrix[3] = new Array(matrixSize);
            displayMatrix[4] = new Array(matrixSize);
            displayMatrix[5] = new Array(matrixSize);
            displayMatrix[6] = new Array(matrixSize);
            displayMatrix[7] = new Array(matrixSize);




            //2D matrix for words placed
            // todo dynamically generate this any size
            var letterMatrix = new Array(matrixSize);
            letterMatrix[0] = new Array(matrixSize);
            letterMatrix[1] = new Array(matrixSize);
            letterMatrix[2] = new Array(matrixSize);
            letterMatrix[3] = new Array(matrixSize);
            letterMatrix[4] = new Array(matrixSize);
            letterMatrix[5] = new Array(matrixSize);
            letterMatrix[6] = new Array(matrixSize);
            letterMatrix[7] = new Array(matrixSize);

            //2D matrix for words height
            var heightMatrix = new Array(matrixSize);

            heightMatrix[0] = new Array(matrixSize);
            heightMatrix[1] = new Array(matrixSize);
            heightMatrix[2] = new Array(matrixSize);
            heightMatrix[3] = new Array(matrixSize);
            heightMatrix[4] = new Array(matrixSize);
            heightMatrix[5] = new Array(matrixSize);
            heightMatrix[6] = new Array(matrixSize);
            heightMatrix[7] = new Array(matrixSize);


            // create objects for front screen and level splsh screen
            displayFrontTitle = null;
            displayFrontComment1 = null;
            displayFrontComment2 = null;
            displayFrontComment3 = null;
            // create objects for 



            // create objects for commentary and score ingame 
            displayComment = null;
            displayWordList = null; 
            displayScore= null;
            displayNextLevelScore= null;
        



            // figure out whether we are using a url based level


            //levelName = levelName.replace(/%20/g," ");
            searchValues = decodeURI(window.location.search);
            
            // if no parameters are passed, run test script

            if (searchValues.length>0) {

                //window.location.serach

                //reuseStart = searchValues.search("reuse=");
                
                
                delimeter = searchValues.search(";");
                //reuseValue = searchValues.substring(reuseStart+6,reuseEnd-reuseStart+1);
                reuseValue = searchValues.substring(1,delimeter);
                

                searchValues = searchValues.substring(delimeter+1,1024);

                delimeter = searchValues.search(";");
                levelName =searchValues.substring(0,delimeter);

                searchValues = searchValues.substring(delimeter+1,1024);

                delimeter = searchValues.search(";");
                levelComment =searchValues.substring(0,delimeter);
                
                searchValues = searchValues.substring(delimeter+1,1024);


                levelWordsArray =searchValues.split(";");
                

                
                console.log(searchValues);
                console.log (reuseValue);
                console.log(levelName);
                console.log(levelComment);
                console.log(levelWordsArray);
                console.log("----");
                console.log(delimeter,reuseValue );

                urlGame = "Yes";


                levelWordList[0] = searchValues.split(";");
                levelWordMinScore[0] = reuseValue;
                wordListLen = levelWordList[0].length;

            }

            else {
                console.log ("boot to main menu");
                
                urlGame = "No";
            }
            
            


            function initScene() { }

            function preloadScene() {
                this.load.image("plane", "plane.png");
            }

            function createScene() {

                //set up matrix
          


            



                // text example from https://phasergames.com/phaser-3-basics-images-text-and-click/
        
                //w2 = this.add.text(widthText, widthText*11, "A",textConfig);    
        
                

                //aTaskBar = this.add.text(0,0,"01234567890123456789",textConfig);
 
                
                displayFrontTitle = this.add.text(heightText*.2,heightText*5,"",textConfig)
                displayFrontComment1 = this.add.text(heightText*.2,heightText*6,"",textStatusConfig)
                displayFrontComment2 = this.add.text(heightText*.2,heightText*6,"",textStatusConfig)


                
                displayComment= this.add.text(heightText*.2,heightText*(9.5)+heightOffset, ("COMMENT"), textStatusConfig);
                displayScore= this.add.text(heightText*.2,heightText*(10)+heightOffset, ("SCORE"), textStatusConfig);
                displayWordList = this.add.text(heightText*.2,heightText*(10.5)+heightOffset,("LIST"), textStatusConfig); 
                displayNextLevelScore= this.add.text(heightText*.2,heightText*(11)+heightOffset,("NEXT"), textStatusConfig); 
                //line1 = new Phaser.Line(100, 100,100, 100);
                
                console.log("********")
                console.log(widthText, heightText)

                var currentHeighText = 1 ;
                

                landscape = this.add.graphics();

                // initialise objects, set alpha  to 0.
                // when object wanted, change alpha 

                   console.log ('init screen');
                for (x = 0;x<8;x++ ) {
                
                for (y = 0 ;y<8;y++) {
                    displayMatrix[x][y]= this.add.text((widthText*(x+1))+widthOffset, (heightText*(y+1))+heightOffset, "#" ,textConfig);
                    displayMatrix[x][y].alpha =0.0;
                }
               } 


                //letterMatrix = this.add.text((widthText*(1+1))+widthOffset, (heightText*(1+1))+heightOffset, "#" ,textConfig);

                // initDisplayLevel_Dev();

                //GR.LINE n,wt, ht* cyid, wt*9, ht * cyid


/*
                GR.LINE n,wt, ht, wt*9, ht
                GR.LINE n,wt, ht, wt, ht*8
                GR.LINE n,wt*9, ht, wt*9, ht*8
*/
                
                plane = this.add.sprite(640, 360, "plane");
                plane.setScale(0.4);


                doLogic();


            }

            function clearScene()
            {
        
            }


            //function updateScene() { }
            /* option 1 direct */
            function updateScene() {

                if(!this.input.activePointer.isDown && isClicking == true) {
                    plane.x = this.input.activePointer.position.x;
                    plane.y = this.input.activePointer.position.y;
                    isClicking = false;

                    console.log("---Position---");
                    console.log(this.input.activePointer.position.x);  
                    console.log(this.input.activePointer.position.y);   

                    plane.alpha = 1.0;

                    x1 = x2;
                    y1 = y2;    
                    x2 = parseInt(this.input.activePointer.position.x/game.config.width*matrixWidth);
                    y2 = parseInt(this.input.activePointer.position.y/game.config.width*matrixWidth);

                    getUserState();

                } else if(this.input.activePointer.isDown && isClicking == false) {
                    isClicking = true;
                }

                if(plane.alpha<=0.1) {
                    touchAlphaChange = 0.01;
                } else if (plane.alpha>=0.9) {
                    touchAlphaChange = -0.01;
                }

             plane.alpha += touchAlphaChange;

            // w2.setText(x2+" "+y2+" "+x1+" "+y1);

            //doLogic();

            }

            function getUserState() {
                /*
                    1) Compare current click XY postions to previous
                    decide whether it is up down left right or same

                    2) Decide Click state (for valid clicks)
                    on 0th click = ready
                    on 1st click = anchor
                    on 2nd click decide action
                            if first click <> second click
                                place word
                            if firstclick = second click
                                remove anchor
                        then set user state to be ready
                */

                
                console.log("User state logged")


                console.log("---old position----");
                console.log(x1);
                console.log(y1);
                console.log("---new position----");
                console.log(x2);
                console.log(y2);
                console.log("-------");



                // check if user input is vertical
                if (x1 == x2) {
                    xShift = 0; 
                    if (y1 == y2) {
                        yShift = 0;
                        console.log("no direction indicated");
                    }
                    else if (y1 < y2) {
                        console.log("verticle down");
                        yShift = 1;
                    }
                    else if (y1 > y2) {
                        console.log("verticle up");
                        yShift = -1;
                    }
                    else {
                        console.log("error!");
                    }

                }
                // check if user input is horizontal
                else if (y1 == y2) {
                    yShift = 0;
                    if (x1 < x2) {
                    console.log("horizontal right");
                    xShift = 1;
                    }
                    else if (x1 > x2) {
                        console.log("horizontal left");
                        xShift = -1;
                    }
                    else {
                        console.log("no direction");
                    }
                }
                else {

                }


                console.log ("Previous XY ",x1,y1);
                console.log (xShift,yShift);

                /*
                ## If phase = 'readyForLevel'
                */
                
                if (phase!='level') {
                    doLogic();
                }



                /*
                ## IF phase = 'level'
                2) Decide Click state (for valid clicks)
                on 0th click = ready
                on 1st click = anchor
                on 2nd click decide action
                        if first click <> second click
                            place word
                        if firstclick = second click
                            remove anchor
                    then set user state to be ready
                */
                
                
                
                else if (phase ='level'){
                
                    if (userState == 'ready') {
                        userState = 'anchor';

                    }
                    else if (userState =='anchor') {
                        if (xShift + yShift != 0) {  
                            userState = 'place';
                        }
                        // implied here is that we want to re anchor the text 
                    }
                    else if (userState == 'place') {
                        userState = 'anchor';
                    }


                    console.log(userState);


                    /*
                    if anchor is within the  playfield,
                    placewords
                    else funstuff
                    */




                
                    if (userState == 'place' 
                    && x1>0 && x1<9 
                    && y1>0 && y1<9
                    ) {
                        console.log ('please place word')


                        placeWord();
                        userState = 'ready';
                    }
                }


            
            }


            function placeWord2() {
                if (userState =='place') {
                    console.log ('placing word ABC');
                    userState = 'ready';

                }

            }



            function placeWord() {


                console.log ("Place current word:", levelWordList[level][wordID])
                var currentWord = levelWordList[level][wordID].split("");
                var currentWordLen = currentWord.length;

                // turn postion in to array location ..Hack fix
                x1--;
                y1--;

                if (xShift + yShift != 0) {
				console.log("xshift " + xShift + " yshift " + yShift);

				for (var a = 0; a < currentWordLen; a++) {

					if (letterMatrix[x1][y1] == currentWord[a]) {
						score += 1;
						totalScore += 1;
						console.log("point gained +1");
					}

					if (letterMatrix[x1][y1] != currentWord[a]) {
						letterMatrix[x1][y1] = currentWord[a];
						heightMatrix[x1][y1] = heightMatrix[x1][y1] + 1;
						console.log(letterMatrix[x1][y1]);
					}



					console.log(currentWord[a]);
					console.log(x1);
					console.log(y1);

					y1 = (y1 + yShift) % (matrixSize);
					x1 = (x1 + xShift) % (matrixSize);


					if (x1 < 0) {
						x1 = matrixSize - 1
					}

					if (y1 < 0) {
						y1 = matrixSize - 1
					}


				}
				wordID++;

                userState = 'ready';

				refreshDisplayLevel();
			}

		}




        function initDisplayLevel_Dev() {
            

            landscape.lineStyle(1, 0xFFFFFF, 1);

            // draw matrix
            for (let i =1; i<=9 ; i++)
                {
                    landscape.moveTo(widthText, heightText*i);
                    landscape.lineTo(widthText*9, heightText*i);
                }

                for (let i =1; i<=9 ; i++)
                {
                    landscape.moveTo(widthText*i, heightText);
                    landscape.lineTo(widthText*i, heightText*9);
                }

                landscape.alpha = 1.0;
                landscape.strokePath();


                displayComment.alpha = 1.0;
                displayScore.alpha = 1.0;
                displayNextLevelScore.alpha = 1.0;
                displayWordList.alpha = 1.0;


        }

        function clearDisplayLevel_Dev()
        {
            landscape = null;

        }


        function refreshDisplayLevel() {

			for (var x1 = 0; x1 < matrixSize; x1++) {

				for (var y1 = 0; y1 < matrixSize; y1++) {
                    displayMatrix[x1][y1].setText(letterMatrix[x1][y1]);
                    if (letterMatrix[x1][y1]!= '#') {
                        displayMatrix[x1][y1].alpha = 1.0;
                    }
				}

			}


            initDisplayLevel_Dev();

            displayFrontTitle.alpha = 0.0;
            displayFrontComment1.alpha = 0.0;

            /*

			//context.fillText("a", Math.ceil(xUp/50)*50-25, Math.ceil(yUp/50)*50-25);
			//console.log ("x=" + Math.ceil(xUp/50) + " y=" + Math.ceil(yUp/50));	
			context.fillStyle = "blue";
			context.font = "bold 15px Courier New";
            */
			if (wordID < wordListLen) {
				displayComment.setText("Reuse as many letters as you can:");
				displayWordList.setText(levelWordList[level].toString());
				displayScore.setText("Current score: " + score + " TotalScore: " + totalScore);
				displayNextLevelScore.setText("Score to unlock next level: " + levelWordMinScore[level]);
			}

			if (wordID == wordListLen) {
				displayScore.setText("Current score: " + score);
				
				if (score < levelWordMinScore[level]) {
					displayComment.setText("You have failed to save enough letters");
					displayWordList.setText("Click here to continue...");
					level = 0;
					wordID = 0;
					score = 0;
					totalScore = 0;
					phase = "frontScreen";
				}
				else {
					displayComment.setText("Congrats! You have unlocked the next level..");
					displayWordList.setText("Click here to continue...");
					level += 1;

					if (level == totalLevels) {
						phase = "playerWon";
					}
					else {
						phase = "readyForLevel";
						wordID = 0;
						score = 0;
						wordListLen = levelWordList[level].length;
						//populateDefaultLetterMatrix();

					}
				}


			}
	
        }

        function populateDefaultLetterMatrix()
        {
            for (x = 0;x<8;x++ ) {
                for (y = 0 ;y<8;y++) {
                    letterMatrix[x][y]= "#";
                    displayMatrix[x][y].alpha = 0.0;
                }
               } 

        }

		function doLogic() {

            console.log("phase " + phase + "  doLogic");
            if (phase == "frontScreen") {
                refreshDisplayFrontScreen();
                phase = "readyForLevel";
            }
            else if (phase == "readyForLevel") {
                refreshDisplayReadyForLevel();
                phase = "levelSetUp";
            }
            else if (phase == "levelSetUp") {
                refreshDisplayLevel();
                phase = "level";
            }
            else if (phase == "level") {
                placeWord();
            }
            else if (phase == "playerWon") {
                refreshDisplayPlayerWon();
                phase = "frontScreen";
            }

            xDown = undefined;
            yDown = undefined;
            xUp = undefined;
            yUp = undefined;

            console.log ("Next phase:"+ phase);


        }



		function refreshDisplayFrontScreen() {



            landscape.alpha = 0.0;

            displayFrontTitle.alpha = 1.0;
            displayFrontTitle.setText( "Welcome to Wordga");
            displayFrontComment1.alpha = 1.0;
            displayFrontComment1.setText("Tap to start")
            displayFrontComment2.alpha = 1.0;


            displayComment.alpha = 0.0;
            displayScore.alpha = 0.0;
            displayNextLevelScore.alpha = 0.0;
            displayWordList.alpha = 0.0;


			console.log("phase" + phase + "  refreshDisplayFrontScreen");

            populateDefaultLetterMatrix();

			xDown = 0;
			yDown = 0;
			xUp = 0;
			yUp = 0;

		}


		function refreshDisplayReadyForLevel() {

            landscape.alpha = 0.0;
            displayFrontTitle.alpha = 1.0;
            displayFrontTitle.setText("Level "+ level);
            displayFrontComment1.alpha = 1.0;
            displayFrontComment1.setText("tap to continue..")
            displayFrontComment2.alpha = 1.0;


            displayComment.alpha = 0.0;
            displayScore.alpha = 0.0;
            displayNextLevelScore.alpha = 0.0;
            displayWordList.alpha = 0.0;

            populateDefaultLetterMatrix();

			xDown = 0;
			yDown = 0;
			xUp = 0;
			yUp = 0;

            //doLogic();

		}


		function refreshDisplayPlayerWon() {

			displayFrontTitle.setText("You have Won!");
			displayFrontComment1.setText("Click here to continue..");

			xDown = 0;
			yDown = 0;
			xUp = 0;
			yUp = 0;

		}



/*
    function drawMatrix ()
    {
        GR.LINE n,wt, ht, wt*9, ht
        GR.LINE n,wt, ht, wt, ht*8
        GR.LINE n,wt*9, ht, wt*9, ht*8
    }
    */

        </script>
    </body>
</html>
