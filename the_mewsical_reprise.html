<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I-mog-en: The Mewsical - Bubblegum Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">

    <!-- <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet"> -->
    <style>
        /* Custom styles for the bubblegum look and animation */

        /* Define the text "breath" animation (Scale effect) */
        @keyframes textBreath {
            0% { 
                transform: scale(1.0);
            }
            50% { 
                transform: scale(1.08); /* Making pulse significantly bigger */
                text-shadow: 
                    -8px -8px 0 #6d5b9b, 
                    8px 8px 0 #33ffff, 
                    -2px -2px 0 #fff; 
            }
            100% { 
                transform: scale(1.0);
            }
        }

        /* Define the color flash/vibration animation */
        @keyframes colorFlash {
            0%, 100% {
                color: #ff69b4; /* Hot Pink */
            }
            50% {
                color: #ffff00; /* Electric Yellow */
            }
        }

        /* Define the bubble font style */
        .bubble-title {
            font-family: 'Luckiest Guy', cursive;
            line-height: 1;
            
            /* Enhanced Neon Shadow for Title */
            text-shadow: 
                -5px -5px 0 #5f4b8b, 
                5px 5px 0 #00ffff, 
                0 0 10px #ff00ff, /* Pink Neon Glow */
                0 0 20px #00ffff, /* Blue Neon Glow */
                -2px -2px 0 #fff; 

            /* Apply breathing AND fast, annoying color flashing */
            animation: textBreath 3s ease-in-out infinite alternate,
                       colorFlash 0.2s linear infinite; /* Fast, annoying color shift */
        }

        /* Subtitle Bounce Animation (Quick, fast-paced rhythm) */
        @keyframes subtitleBounce {
            0%, 100% {
                transform: translateY(0) scale(1.0);
            }
            50% {
                transform: translateY(-2px) scale(1.05); /* Quick little jump and slight scale */
            }
        }

        /* Subtitle Garish Style - Used for both the main subtitle and the new dropdown label */
        .subtitle-garish {
            font-family: 'Luckiest Guy', cursive;
            color: #ffff00; /* Electric Yellow as primary color */
            text-shadow: 
                -3px -3px 0 #ff69b4, /* Pink shadow */
                3px 3px 0 #00ffff, /* Cyan highlight */
                0 0 8px #ff00ff; /* Subtle glow */
            line-height: 1;
            /* Applying a quick, rhythmic bounce */
            animation: subtitleBounce 0.3s ease-in-out infinite alternate;
        }
        
        /* Dropdown Wobble Animation - Keeping the definition, but removing application below */
        @keyframes selectWobble {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(-0.5deg); } /* Tiny, annoying rotation */
        }
        
        /* Dropdown Garish Style */
        .song-select-garish {
            font-family: 'Luckiest Guy', cursive;
            /* UPDATED: High Contrast Black Text for readability */
            color: #000000; 
            background-color: #00ffff; /* Cyan Background */
            border: 4px solid #ff69b4; /* Hot Pink Border */
            padding: 0.5rem 1.5rem;
            
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* Add custom arrow (using a background image for complexity, though not strictly required) */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23FF69B4" d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.5em;
        }

        /* Define the RHYTHMIC "jitter" animation (0.5s cycle = 120 BPM) */
        @keyframes rhythmicJitter {
            0% { 
                transform: translateY(0) rotate(0deg) scale(2.0); 
            }
            25% { 
                transform: translateY(5px) rotate(2deg) scale(1.95); 
            }
            50% { 
                transform: translateY(-15px) rotate(-8deg) scale(2.10); 
            }
            75% { 
                transform: translateY(0) rotate(0deg) scale(2.0); 
            }
            100% { 
                transform: translateY(0) rotate(0deg) scale(2.0); 
            }
        }

        .cat-animated {
            animation: rhythmicJitter 0.5s ease-out infinite;
            cursor: pointer; 
        }

        /* Hyperactive Bubble background pattern (Background Frenzy) */
        .bubble-bg {
            background: #ffffff; 
            background-image: 
                radial-gradient(circle at 5% 15%, rgba(255, 20, 147, 0.4) 0%, transparent 70%), 
                radial-gradient(circle at 75% 85%, rgba(0, 255, 255, 0.5) 0%, transparent 70%), 
                radial-gradient(circle at 30% 60%, rgba(255, 165, 0, 0.3) 0%, transparent 70%),
                radial-gradient(circle at 90% 10%, rgba(128, 0, 128, 0.3) 0%, transparent 60%); 
            background-size: 200px 200px, 300px 300px, 150px 150px, 350px 350px;
            animation: moveBubbles 15s linear infinite; /* Accelerated speed */
        }

        @keyframes moveBubbles {
            from { background-position: 0 0, 0 0, 0 0, 0 0; }
            to { background-position: 200px 200px, -300px 300px, 150px -150px, -350px 350px; }
        }
        
        /* Button wobble animation */
        @keyframes buttonWobble {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            33% { transform: translateY(-1px) rotate(1deg); }
            66% { transform: translateY(1px) rotate(-1deg); }
        }

        /* Custom button styling */
        .start-button {
            transition: none; 
            
            /* Updated shadow for wobble/press state AND neon glow */
            box-shadow: 0 8px 0 0 #5f4b8b, 
                        0 0 10px #ff00ff, 
                        0 0 20px #00ffff; 
            
            animation: buttonWobble 0.2s linear infinite; 
        }

        .start-button:active {
            box-shadow: 0 2px 0 0 #5f4b8b, 
                        0 0 10px #ff00ff,
                        0 0 20px #00ffff;
            transform: translateY(6px);
            animation: none; 
        }
    


        /* Embedded CSS adapted for Bubblegum Theme */
        
        /* General Body and Text changes: Dark BG -> Light BG, White Text -> Dark Text */
        body {
            margin: 0;
            padding: 0;
            background-color: #F8F8FF; /* Ghost White */
            font-family: 'Fredoka One', cursive;
            overflow: hidden;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 90vh;
            color: #5A189A; /* Dark Purple Text for contrast */
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 90vh;
            /* Light Pink/White Gradient */
            background: linear-gradient(180deg, #FFE4E1 0%, #FFFFFF 100%); 
            box-shadow: 0 0 30px rgba(236, 72, 153, 0.4); /* Pink Shadow */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Overlays */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95); /* Semi-transparent White */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            transition: opacity 0.3s;
        }

        /* H1 Title: Hot Pink with Blue Shadow */
        h1 {
            font-size: 3rem;
            color: #EC4899; /* Bright Fuchsia/Pink */
            text-shadow: 3px 3px 0px #3B82F6; /* Bright Blue Shadow */
            margin-bottom: 5px;
            text-align: center;
            line-height: 1.1;
        }

        /* Subtitle: Bright Blue */
        .subtitle {
            font-size: 1.2rem;
            color: #3B82F6; /* Bright Blue */
            margin-bottom: 20px;
        }

        /* General Paragraph Text */
        p {
            font-size: 1.2rem;
            text-align: center;
            margin: 10px 20px;
            color: #5A189A; /* Dark Purple Text */
        }

        /* Primary Button: Hot Pink with Darker Purple Shadow */
        .btn {
            background: #EC4899; /* Fuchsia */
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Fredoka One', cursive;
            margin-top: 15px;
            box-shadow: 0 6px 0 #A78BFA; /* Light Purple Shadow */
            transition: transform 0.1s;
            width: 80%;
            max-width: 300px;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #A78BFA;
        }
        
        .btn:disabled {
            background: #ccc;
            box-shadow: 0 4px 0 #999;
            cursor: default;
        }

        /* Secondary Button: Teal/Cyan with Darker Shadow */
        .btn-secondary {
            background: #22D3EE; /* Cyan */
            box-shadow: 0 6px 0 #0EA5E9; /* Light Blue Shadow */
        }
        
        /* Share Button: Bright Yellow with Dark Text */
        .btn-share {
            background: #FCD34D; /* Bright Yellow */
            color: #5A189A; /* Dark Purple Text */
            box-shadow: 0 6px 0 #FBBF24; /* Amber Shadow */
        }
        
        #loading-status {
            font-size: 1rem;
            color: #3B82F6; /* Bright Blue */
            margin-top: 10px;
        }

        /* HUD Positioning to ensure it floats over canvas */
        #hud-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows clicks to pass through to canvas */
            z-index: 5;
        }

        /* HUD: Needs dark text for light background */
        #score-board, #combo-board {
            position: absolute;
            top: 20px;
            color: #5A189A;
            text-shadow: 1px 1px 0 #fff; /* White outline on dark text for visibility */
            font-size: 1.5rem;
            font-weight: bold;
        }

        #score-board {
            left: 20px;
        }

        /* Combo text: Bright Pink */
        #combo-board {
            right: 20px;
            color: #EC4899;
        }

        /* Lyrics Container: Text should be dark and active text bright pink/blue */
        #lyrics-container {
            position: absolute;
            width: 100%;
            bottom: 140px; /* Positioned just above the hit area */
            text-align: center;
            pointer-events: none;
        }

        .lyric-line {
            font-size: 1.3rem;
            color: rgba(90, 24, 154, 0.4); /* Dark Purple semi-transparent */
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
            transition: all 0.2s;
        }

        .lyric-active {
            font-size: 1.6rem;
            color: #3B82F6; /* Bright Blue */
            transform: scale(1.05);
            text-shadow: 2px 2px 0px #EC4899; /* Pink shadow for pop */
            opacity: 1;
        }

        /* Updated select styles for black text and better contrast */
        select {
            font-size: 1.2rem; 
            padding: 12px; 
            border-radius: 15px; 
            margin-top: 5px; 
            border: 3px solid #EC4899; /* Pink border */
            background: white; 
            font-family: 'Fredoka One';
            width: 80%;
            max-width: 300px;
            outline: none;
            color: #000; 
        }
        select option {
            color: #000;
        }
    </style>
</head>
<body class="bubble-bg min-h-screen flex items-center justify-center p-4">


    <div id="game-container" class="w-full max-w-md bg-white/90 backdrop-blur-sm rounded-3xl p-6 md:p-10 text-center border-4 border-pink-500 shadow-2xl">
        <canvas id="gameCanvas"></canvas>

        <div id="hud-layer">
            <div id="score-board">Score: 0</div>
            <div id="combo-board">Combo: x0</div>
            <div id="lyrics-container"></div>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="overlay">
 
         <!-- Container for Overlapping Text and Image -->
        <div class="relative h-96 sm:h-[30rem] mb-8">
            
            <!-- Text Content (Layer Z-20: In Front of Cat) -->
            <div class="relative z-20 pt-7">
                <h1 class="bubble-title text-5xl sm:text-7xl md:text-8xl select-none whitespace-nowrap -ml-3">
                    I MOG EN
                </h1>
                <p class="subtitle-garish text-2xl md:text-4xl font-bold tracking-wider">
                    The Mewsical!
                </p>
            </div>

            <!-- Animated Cat Image (Layer Z-10: Behind Text) -->
            <div class="absolute inset-x-0 -bottom-32 z-10 flex justify-center">
                <img 
                    src="https://joinusinchance.github.io/game/I_mog_en_front.png" 
                    alt="Imogen the cat ready to play a rhythm game" 
                    class="cat-animated w-full max-w-xs h-auto block transform origin-bottom"
                    onerror="this.onerror=null;this.src='https://placehold.co/200x200/ff69b4/ffffff?text=CAT+IMAGE'"
                />
            </div>
        </div>

  

        <div class="mb-4 relative z-20">
            <!-- UPDATED: Text changed to "Choose Your Tune:" and applied subtitle-garish style -->
            <label for="song-select" class="block mb-2 subtitle-garish text-xl md:text-2xl">Choose Your Tune:</label>
            <select id="song-select" class="song-select-garish w-full text-xl rounded-2xl shadow-lg focus:ring-4 focus:ring-pink-500 transition-colors">
                    <option value="camptown">Camptown Races</option>
                    <option value="ode">Ode to Joy</option>
                    <option value="sevendayslay">Seven Day Slay</option>
                    <option value="entertainer">The Entertainer</option>
                    <option value="korobeiniki">Korobeiniki (Tetris)</option>
                    <option value="mountain">Hall of Mountain King </option>
            </select>
        </div>

        <!-- Start Game Button (Positioned after the overlapping container, ensuring it stacks on top) -->
        <button 
            id="start-btn"
            class="start-button w-full py-4 text-3xl font-bold rounded-full bg-pink-500 text-cyan-400 border-4 border-pink-500 hover:bg-pink-400 uppercase relative z-30"
        >
            Play Now!
        </button>



        </div>


        <!-- Game Over Screen -->
        <div id="game-over-screen" class="overlay hidden" style="display: none;">
            <p class="subtitle-garish text-2xl md:text-4xl font-bold tracking-wider">
                    Finished!
                </p>

            <p>Score: <span id="final-score" style="color:#EC4899;">0</span></p>
            <p>Best Combo: <span id="max-combo" style="color:#3B82F6;">0</span></p>
            <p id="rank-text" style="font-size: 2rem; color: #EC4899; margin: 10px 0"></p>
            <!--
            <button class="btn btn-share" id="share-btn">Share Score</button>
            <button class="btn btn-secondary" id="restart-btn">Play Again</button> -->

        <button 
            id="share-btn"
            class="start-button w-full py-4 text-3xl font-bold rounded-full bg-cyan-500 text-pink-400 border-4 border-pink-500 hover:bg-pink-400 uppercase relative z-30"
        >
            Share Score
        </button>
        <p>
        <button 
            id="restart-btn"
            class="start-button w-full py-4 text-3xl font-bold rounded-full bg-pink-500 text-cyan-400 border-4 border-pink-500 hover:bg-pink-400 uppercase relative z-30"
        >
            Play Again!
        </button>



        </div>
    </div>

    <script>
        // --- Constants (UPDATED LANE COLORS) ---
        // Bubblegum Pink, Blue, Yellow, Purple
        const LANE_COLORS = ['#EC4899', '#3B82F6', '#FCD34D', '#A78BFA']; 
        // Icons: Purse, Pill, Squirrel, Croissant
        const LANE_ITEMS = ['ðŸ‘œ', 'ðŸ’Š', 'ðŸ¿ï¸', 'ðŸ¥']; 
        const MEOW_URL = 'https://joinusinchance.github.io/game/mixkit-sweet-kitty-meow-93.wav';
        const FX_URL = 'https://joinusinchance.github.io/game/mixkit-little-cat-pain-meow-87.wav';
        const PAW_IMAGE_URL = 'https://joinusinchance.github.io/game/paw.png'; 
        const BASE_FREQUENCY = 261.63; // C4
        const OCTAVE_OFFSET = 0.65; 
        const keyMap = { 'KeyD': 0, 'KeyF': 1, 'KeyJ': 2, 'KeyK': 3 };

        // Standard Note Frequencies (Unchanged)
        const NOTE_FREQS = {
            'C2': 65.41, 'C#2': 69.30, 'D2': 73.42, 'D#2': 77.78, 'E2': 82.41, 'F2': 87.31, 'F#2': 92.50, 'G2': 98.00, 'G#2': 103.83, 'A2': 110.00, 'A#2': 116.54, 'B2': 123.47,
            'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46, 'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77,
            'C6': 1046.50
        };

        // Helper to repeat an array (Unchanged)
        const repeat = (arr, times) => Array(times).fill(arr).flat();


        // --- FULL-LENGTH SONG DEFINITIONS (Unchanged) ---

        // 1. CAMPTOWN RACES (110 BPM)
        const camptown_verse = [
            // Camptown ladies sing this song, Doo-dah, Doo-dah!
            ['G4',1],['G4',1],['E4',1],['G4',1], ['A4',1],['G4',1],['E4',2],
            // Camptown race-track five miles long, Oh, doo-dah day!
            ['E4',1],['D4',1],['C4',2], ['E4',1],['D4',1],['C4',2],
        ];
        const camptown_chorus = [
            // Goin' to run all night, Goin' to run all day,
            ['D4',1],['D4',1],['D4',1],['E4',1], ['F4',1],['E4',1],['D4',2],
            // I'll bet my money on the bob-tail nag, somebody bet on the bay.
            ['C4',1],['D4',1],['E4',1],['C4',1], ['G3',4] 
        ];

        // Full song: Verse, Chorus, Verse, Chorus, Coda
        const camptown_full = [].concat(
            camptown_verse, camptown_chorus, 
            camptown_verse, camptown_chorus,
            ['G4',1],['G4',1],['E4',1],['G4',1], ['C4',4] // Coda
        );

        const camptown_lyrics_full = [
            {beat: 0, text: "Camptown ladies sing this song, Doo-dah, Doo-dah!"}, 
            {beat: 8, text: "Camptown race-track five miles long, Oh, doo-dah day!"},
            {beat: 16, text: "Goin' to run all night, Goin' to run all day,"}, 
            {beat: 24, text: "I'll bet my money on the bob-tail nag, somebody bet on the bay."},
            
            {beat: 32, text: "De Camptown ladies am goin' to shine, Doo-dah, Doo-dah!"}, 
            {beat: 40, text: "De sun am done gone down! Oh, doo-dah day!"},
            {beat: 48, text: "Goin' to run all night, Goin' to run all day,"}, 
            {beat: 56, text: "I'll bet my money on the bob-tail nag, somebody bet on the bay."},

            {beat: 64, text: "Final flourish! Doo-dah!"}
        ];

        // 2. ODE TO JOY (120 BPM)
        const ode_a = [
            ['E4', 1], ['E4', 1], ['F4', 1], ['G4', 1],
            ['G4', 1], ['F4', 1], ['E4', 1], ['D4', 1],
            ['C4', 1], ['C4', 1], ['D4', 1], ['E4', 1],
            ['E4', 1.5], ['D4', 0.5], ['D4', 2] 
        ];
        const ode_b = [
            ['D4', 1], ['E4', 1], ['F4', 1], ['F4', 1],
            ['E4', 1], ['D4', 1], ['C4', 1], ['C4', 1],
            ['D4', 1], ['E4', 1], ['F4', 1], ['E4', 1],
            ['D4', 1], ['C4', 1], ['C4', 2] 
        ];

        // Full song: A A B B Coda
        const ode_full = [].concat(
            ode_a, ode_a, ode_b, ode_b, 
            ['C4', 4], ['G3', 4], ['C4', 4] // Coda
        ); 
        const ode_lyrics_full = [
            {beat: 0, text: "Joy, beautiful spark of Divinity, Daughter of Elysium,"}, 
            {beat: 16, text: "We enter, drunk with fire, O heavenly, thy sanctuary!"},
            {beat: 32, text: "Your magic joins again, all that custom has divided,"}, 
            {beat: 48, text: "All men become brothers, wherever thy gentle wings abide."},
            
            {beat: 64, text: "Alle Menschen werden BrÃ¼der! Alle Menschen!"},
            {beat: 80, text: "Freude! SchÃ¶ner GÃ¶tterfunken!"}
        ];
        
        // 3. SEVEN DAY SLAY (130 BPM)
        // Part A (Mon-Fri Grind) - 16 bars
        const seven_day_slay_part_a = [
            ['E4', 0.5], ['E4', 0.5], ['G4', 0.5], ['G4', 0.5], ['E4', 0.5], ['E4', 0.5], ['G4', 0.5], ['G4', 0.5],
            ['G4', 0.5], ['G4', 0.5], ['E4', 0.5], ['E4', 0.5], ['G4', 0.5], ['G4', 0.5], ['E4', 0.5], ['E4', 0.5],
            ['E4', 0.5], ['G4', 0.5], ['E4', 0.5], ['G4', 0.5], ['E4', 0.5], ['G4', 0.5], ['E4', 0.5], ['G4', 0.5],
            ['E4', 0.5], ['G4', 0.5], ['E4', 0.5], ['C4', 0.5], ['E4', 0.5], ['G4', 0.5], ['E4', 0.5], ['C4', 0.5],
            
            ['E4', 0.5], ['E4', 0.5], ['G4', 0.5], ['G4', 0.5], ['E4', 0.5], ['E4', 0.5], ['G4', 0.5], ['G4', 0.5],
            ['G4', 0.5], ['G4', 0.5], ['E4', 0.5], ['E4', 0.5], ['G4', 0.5], ['G4', 0.5], ['E4', 0.5], ['E4', 0.5],
            ['F4', 1], ['F4', 1], ['G4', 1], ['G4', 1], 
            ['A4', 1], ['A4', 1], ['B4', 1], ['B4', 1], 
            
            ['C5', 1], ['C5', 1], ['C5', 1], ['C5', 1], 
            ['B4', 2], ['A4', 2], 
            ['C5', 0.5], ['D5', 0.5], ['E5', 0.5], ['D5', 0.5], ['C5', 0.5], ['D5', 0.5], ['E5', 0.5], ['D5', 0.5],
            ['C5', 0.5], ['B4', 0.5], ['A4', 0.5], ['G4', 0.5], ['C5', 0.5], ['B4', 0.5], ['A4', 0.5], ['G4', 0.5],
            
            ['C5', 0.5], ['D5', 0.5], ['E5', 0.5], ['D5', 0.5], ['C5', 0.5], ['D5', 0.5], ['E5', 0.5], ['D5', 0.5],
            ['C5', 0.5], ['B4', 0.5], ['A4', 0.5], ['G4', 0.5], ['C5', 0.5], ['B4', 0.5], ['A4', 0.5], ['G4', 0.5],
            ['C5', 0.5], ['C5', 0.5], ['B4', 0.5], ['A4', 0.5], ['C5', 0.5], ['C5', 0.5], ['B4', 0.5], ['A4', 0.5],
            ['G4', 2], ['C5', 2] 
        ];

        // Part B (Weekend Reset) - 8 bars
        const seven_day_slay_part_b = [
            ['A4', 1], ['G4', 1], ['F4', 1], ['E4', 1], 
            ['D4', 2], ['E4', 2], 
            ['F4', 1], ['F4', 1], ['E4', 1], ['D4', 1], 
            ['C4', 4], 
            
            ['G4', 0.5], ['G4', 0.5], ['A4', 0.5], ['A4', 0.5], ['G4', 1], ['F4', 1], 
            ['E4', 1], ['D4', 1], ['C4', 2], 
            ['G4', 0.5], ['G4', 0.5], ['A4', 0.5], ['A4', 0.5], ['G4', 1], ['F4', 1], 
            ['E4', 1], ['D4', 1], ['C4', 2]
        ];

        // Full song: A B A B Coda (48 bars total)
        const seven_day_slay_full = [].concat(
            seven_day_slay_part_a, seven_day_slay_part_b,
            seven_day_slay_part_a, seven_day_slay_part_b,
            ['C5', 4], ['G4', 4], // Coda
        );

        const seven_day_slay_lyrics_full = [
            {beat: 0, text: "It's Monday morning, I'm legit stressed out,"}, 
            {beat: 4, text: "But my outfit's giving, so no need to pout!"},
            {beat: 8, text: "Gotta get this bread, gotta be a hun,"}, 
            {beat: 12, text: "Gonna be bossing it 'til the week is done!"},
            {beat: 16, text: "My coffee's cold, but my vibes are hot"}, 
            {beat: 20, text: "Seven whole days, I'll give it all I've got!"},
            {beat: 24, text: "Got my schedule packed, it's a whole mood,"},
            {beat: 28, text: "Misunderstand? I wish you would!"},
            {beat: 32, text: "Counting down the minutes, it's a major key,"},
            {beat: 36, text: "The sweet taste of being free!"},
            {beat: 40, text: "Oh, the Fri-Yays, they're my true love,"},
            {beat: 44, text: "Sent down from the heavens right up above!"},
            {beat: 48, text: "Gimme some LOLZ and all the good Bants,"},
            {beat: 52, text: "I'm just living my best life, taking zero chance!"},
            {beat: 56, text: "Get the prosecco ready, it's Wine-o-clock time,"},
            {beat: 60, text: "This seven-day slay is absolutely sublime!"},
            
            {beat: 64, text: "Saturday night, no drama, just a chill zone,"},
            {beat: 68, text: "Face mask on, gotta restore the glow, all on my own."},
            {beat: 72, text: "Sunday reset, I'm taking it slow, I gotta be kind to me,"},
            {beat: 76, text: "Ready to step out again, full energy!"},

            {beat: 80, text: "Counting down the minutes, it's a major key (Again!),"},
            {beat: 84, text: "The sweet taste of being free (Forever!)"},
            {beat: 88, text: "Gimme some LOLZ and all the good Bants,"},
            {beat: 92, text: "I'm just living my best life, taking zero chance!"},
            
            {beat: 96, text: "Slay accomplished! Wait for the final meow..."}
        ];


        // 4. THE ENTERTAINER (140 BPM)
        const entertainer_part_a = [
            ['D5',0.5],['E5',0.5],['C5',0.5],['A4',1],['B4',0.5],['G4',0.5], 
            ['C5', 0.5], ['A4', 0.5], ['G4', 0.5], ['E4', 0.5], ['C4', 2], 
            ['D5',0.5],['E5',0.5],['C5',0.5],['A4',1],['B4',0.5],['G4',0.5], 
            ['C5', 0.5], ['A4', 0.5], ['G4', 0.5], ['E4', 0.5], ['C4', 2], 
            
            ['D5',0.5],['E5',0.5],['C5',0.5],['A4',1],['B4',0.5],['G4',0.5], 
            ['E4',0.5],['F4',0.5],['G4',0.5],['E4',0.5],['C4',2], 
            ['G4', 0.5], ['F4', 0.5], ['E4', 0.5], ['D4', 0.5], ['C4', 2], 
            ['C4', 1], ['D4', 1], ['E4', 1], ['F4', 1], 
        ];
        const entertainer_part_c = [
            ['C5', 2], ['G4', 2], 
            ['C5', 2], ['G4', 2], 
            ['C5', 1], ['D5', 1], ['E5', 1], ['F5', 1], 
            ['G5', 4], 
            
            ['F5', 1], ['E5', 1], ['D5', 1], ['C5', 1], 
            ['B4', 1], ['A4', 1], ['G4', 1], ['F4', 1], 
            ['E4', 2], ['D4', 2], 
            ['C4', 4] 
        ];

        // Full song: A C A Coda (30 bars total)
        const entertainer_full = [].concat(
            entertainer_part_a, entertainer_part_c, 
            entertainer_part_a, 
            ['C4', 4] // Coda
        ); 
        const entertainer_lyrics_full = [
            {beat: 0, text: "Ragtime Intro... The Cat is here to entertain!"}, 
            {beat: 16, text: "Sliding on the keys, tapping every beat."},
            {beat: 32, text: "The Trio begins, a change of tone."}, 
            {beat: 48, text: "Soaring high notes, reaching the musical zenith."},
            
            {beat: 64, text: "Back to the main theme, hit the rhythm!"},
            {beat: 80, text: "This is the sound of pure, happy ragtime."},
            {beat: 96, text: "Final flourish! Enjoy the show!"}
        ];


        // 5. KOROBEINIKI (TETRIS - 140 BPM)
        const korobeiniki_part_a = [
            ['E4', 1], ['B3', 0.5], ['C4', 0.5], ['D4', 1], ['C4', 0.5], ['B3', 0.5],
            ['A3', 1], ['A3', 0.5], ['C4', 0.5], ['E4', 1], ['D4', 0.5], ['C4', 0.5],
            ['B3', 1], ['B3', 0.5], ['C4', 0.5], ['D4', 1], ['E4', 1],
            ['C4', 1], ['A3', 1], ['A3', 1]
        ];

        const korobeiniki_part_b = [
            ['D4', 1.5], ['F4', 0.5], ['A4', 1], ['G4', 0.5], ['F4', 0.5],
            ['E4', 1.5], ['C4', 0.5], ['E4', 1], ['D4', 0.5], ['C4', 0.5],
            ['B3', 1], ['B3', 0.5], ['C4', 0.5], ['D4', 1], ['E4', 1],
            ['C4', 1], ['A3', 1], ['A3', 1]
        ];

        // Full song: A B A B Coda
        const korobeiniki_full = [].concat(
            korobeiniki_part_a, korobeiniki_part_b,
            korobeiniki_part_a, korobeiniki_part_b,
            ['E4', 2], ['C4', 2], ['A3', 4] // Coda
        ); 
        const korobeiniki_lyrics_full = [
            {beat: 0, text: "The iconic theme starts now... Get ready to twist and stack!"}, 
            {beat: 16, text: "Can you keep up with the Russian folk tune?"},
            {beat: 32, text: "The tempo is high, don't miss a beat!"}, 
            {beat: 48, text: "Keep pushing, the stack is getting higher..."},
            
            {beat: 64, text: "Back to the start! Faster, faster!"},
            {beat: 80, text: "The boxes are falling, find the perfect fit!"},
            {beat: 96, text: "Endless mode engaged... Just kidding! Almost done."},
            {beat: 112, text: "Success! Tetris master!"}
        ];

        // 6. HALL OF THE MOUNTAIN KING (160 BPM)
        const mountain_part_a = [
            ['B3',0.5],['C#4',0.5],['D4',0.5],['E4',0.5],['F#4',0.5],['D4',0.5],['F#4',1],
            ['F#4',0.5],['D4',0.5],['F#4',1], ['F#4',0.5],['D4',0.5],['F#4',1],
            ['B3',0.5],['C#4',0.5],['D4',0.5],['E4',0.5],['F#4',0.5],['D4',0.5],['F#4',1],
            ['A4',0.5],['G4',0.5],['E4',1], ['F#4',0.5],['D4',0.5],['B3',1]
        ];

        const mountain_part_b = [
            ['B4',0.5],['C#5',0.5],['D5',0.5],['E5',0.5],['F#5',0.5],['D5',0.5],['F#5',1],
            ['F#5',0.5],['D5',0.5],['F#5',1], ['F#5',0.5],['D5',0.5],['F#5',1],
            ['B4',0.5],['C#5',0.5],['D5',0.5],['E5',0.5],['F#5',0.5],['D5',0.5],['F#5',1],
            ['A5',0.5],['G5',0.5],['E5',1], ['F#5',0.5],['D5',0.5],['B4',1]
        ];

        // Full song: A B A Coda
        const mountain_full = [].concat(
            mountain_part_a, mountain_part_b,
            mountain_part_a,
            ['B4', 0.5], ['A4', 0.5], ['G4', 0.5], ['F#4', 0.5], ['E4', 4] // Crash/End
        ); 
        const mountain_lyrics_full = [
            {beat: 0, text: "Deep in the mountain, the king is approaching..."}, 
            {beat: 16, text: "Creeping faster, the melody rises..."},
            {beat: 32, text: "The tension builds! Higher and louder notes!"}, 
            {beat: 48, text: "Don't fall! Don't miss the fast beats!"},
            
            {beat: 64, text: "Back to the shadows, the chase continues..."},
            {beat: 80, text: "This is the final surge! Run for your life!"},
            {beat: 96, text: "Silence! You escaped!"}
        ];
        
        // --- SONGS Object Definition (Unchanged) ---
        const SONGS = {
            'camptown': { bpm: 110, notes: camptown_full, lyrics: camptown_lyrics_full},
            'ode': { bpm: 120, notes: ode_full, lyrics: ode_lyrics_full},
            'sevendayslay': { bpm: 130, notes: seven_day_slay_full, lyrics: seven_day_slay_lyrics_full},
            'entertainer': { bpm: 140, notes: entertainer_full, lyrics: entertainer_lyrics_full},
            'korobeiniki': { bpm: 140, notes: korobeiniki_full, lyrics: korobeiniki_lyrics_full},
            'mountain': { bpm: 160, notes: mountain_full, lyrics: mountain_lyrics_full}
        };

        // --- Global Game State (Unchanged) ---
        let canvas, ctx;
        let gameState = {};
        let audioEngine = null;
        let animationFrameId;
        let floatingTexts = [];
        let activeLanes = [false, false, false, false];
        let pawStamps = []; 
        let pawImage = new Image(); 

        // --- UI Elements (Unchanged) ---
        const ui = {
            startScreen: null, gameOverScreen: null, startBtn: null, 
            loadingStatus: null, scoreBoard: null, comboBoard: null, 
            finalScore: null, maxCombo: null, rankText: null, 
            songSelect: null, lyricsContainer: null, shareBtn: null, restartBtn: null
        };
        
        // --- Game Setup (Unchanged) ---

        const initUI = () => {
            ui.startScreen = document.getElementById('start-screen');
            ui.gameOverScreen = document.getElementById('game-over-screen');
            ui.startBtn = document.getElementById('start-btn');
            ui.loadingStatus = document.getElementById('loading-status');
            ui.scoreBoard = document.getElementById('score-board');
            ui.comboBoard = document.getElementById('combo-board');
            ui.finalScore = document.getElementById('final-score');
            ui.maxCombo = document.getElementById('max-combo');
            ui.rankText = document.getElementById('rank-text');
            ui.songSelect = document.getElementById('song-select');
            ui.lyricsContainer = document.getElementById('lyrics-container');
            ui.shareBtn = document.getElementById('share-btn');
            ui.restartBtn = document.getElementById('restart-btn');
        };

        const resize = () => {
            if (canvas) {
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
                // Set the hit line 100px from the bottom to define the extended hit zone
                gameState.hitY = canvas.height - 100;
            }
        };

        // --- Audio Engine (Unchanged) ---
        const initAudioEngine = async () => {
            let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            let masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.6; 
            masterGain.connect(audioCtx.destination);
            
            let meowBuffer = null;
            let fxBuffer = null;
            let loadedCount = 0;
            const TOTAL_ASSETS = 3; // Audio FX, Meow Audio, Paw Image
            let isLoaded = false;

            const updateLoadingStatus = (message) => {
                if (ui.loadingStatus) ui.loadingStatus.innerText = message;
            };

            const checkLoadComplete = () => {
                loadedCount++;
                if (loadedCount === TOTAL_ASSETS) {
                    isLoaded = true;
                    updateLoadingStatus("Audio & Assets Ready! Tap to Start.");
                    ui.startBtn.disabled = false;
                }
            };
            
            const loadAudioFile = async (url, bufferName) => {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${url}`);
                    const arrayBuffer = await response.arrayBuffer();
                    const buffer = await audioCtx.decodeAudioData(arrayBuffer);
                    
                    if (bufferName === 'meowBuffer') meowBuffer = buffer;
                    if (bufferName === 'fxBuffer') fxBuffer = buffer;

                    checkLoadComplete();
                } catch (error) {
                    console.error(`Error loading ${bufferName}:`, error);
                    updateLoadingStatus("Error loading audio. Check console.");
                }
            };

            // Load Paw Image
            const loadPawImage = () => {
                pawImage.onload = checkLoadComplete;
                pawImage.onerror = (e) => {
                    console.error("Error loading paw image:", e);
                    updateLoadingStatus("Error loading paw image.");
                };
                pawImage.src = PAW_IMAGE_URL;
                pawImage.crossOrigin = "anonymous";
            };

            updateLoadingStatus("Loading Cat Audio & Assets...");
            loadAudioFile(MEOW_URL, 'meowBuffer');
            loadAudioFile(FX_URL, 'fxBuffer');
            loadPawImage();

            audioEngine = {
                init: () => { if (audioCtx.state === 'suspended') audioCtx.resume(); },
                playMeow: (freq) => {
                    if (!audioCtx || !meowBuffer || !isFinite(freq)) return;
                    const source = audioCtx.createBufferSource();
                    source.buffer = meowBuffer;
                    const playbackRate = (freq / BASE_FREQUENCY) * OCTAVE_OFFSET;
                    source.playbackRate.value = playbackRate;
                    const gainNode = audioCtx.createGain();
                    gainNode.gain.setValueAtTime(1.0, audioCtx.currentTime);
                    source.connect(gainNode);
                    gainNode.connect(masterGain);
                    source.start(0);
                    source.onended = () => { source.disconnect(); gainNode.disconnect(); };
                },
                playUISound: () => {
                    if (!audioCtx || !fxBuffer) return;
                    const source = audioCtx.createBufferSource();
                    source.buffer = fxBuffer;
                    const gainNode = audioCtx.createGain();
                    gainNode.gain.value = 0.4; 
                    source.connect(gainNode);
                    gainNode.connect(masterGain);
                    source.start(0);
                    source.onended = () => { source.disconnect(); gainNode.disconnect(); };
                },
                playHitSound: (rating) => {
                    if (!audioCtx) return;
                    const now = audioCtx.currentTime;
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(masterGain);

                    if (rating === 'miss') {
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(80, now);
                        osc.frequency.linearRampToValueAtTime(60, now + 0.1);
                        gain.gain.setValueAtTime(0.2, now);
                        gain.gain.linearRampToValueAtTime(0.001, now + 0.2);
                        osc.start();
                        osc.stop(now + 0.2);
                    } else if (rating === 'perfect') {
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(600, now);
                        osc.frequency.exponentialRampToValueAtTime(1000, now + 0.15);
                        gain.gain.setValueAtTime(0.3, now);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                        osc.start();
                        osc.stop(now + 0.2);
                    } else {
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(1200, now);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                        osc.start();
                        osc.stop(now + 0.05);
                    }
                },
                getCurrentTime: () => audioCtx.currentTime, 
                isLoaded: () => isLoaded,
                NOTE_FREQS
            };
        };

        // --- Game Logic Helpers (Unchanged) ---

        const updateScoreboard = () => {
            if (ui.scoreBoard) ui.scoreBoard.innerText = `Score: ${gameState.score}`;
            if (ui.comboBoard) ui.comboBoard.innerText = `Combo: x${gameState.combo}`;
        };

        const createFloatingText = (text, x, y, color) => {
            floatingTexts.push({ text, x, y, color, life: 1.0 });
        };

        const spawnParticles = (x, y, color) => {
            for (let i = 0; i < 10; i++) {
                gameState.particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15,
                    life: 1.0, color: color
                });
            }
        };

        // Paw Stamp Creation Function - Updated to include lane index
        const createPawStamp = (lane, x, y, color) => {
            if (!pawImage.complete) return;
            pawStamps.push({
                lane: lane, 
                x: x, 
                y: y+ 20, 
                rotation: (Math.random() - 0.5) * Math.PI / 4, 
                size: 90 + Math.random() * 30, 
                life: 1.0, 
                color: color
            });
        };

        // Simplified Paw Drawing for the target area 
        const drawPaw = (ctx, x, y, size, color) => {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            ctx.fill();
            const tDist = size * 1.2;
            const tSize = size * 0.4;
            ctx.beginPath(); ctx.arc(x - tDist*0.7, y - tDist*0.7, tSize, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(x, y - tDist, tSize*1.1, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(x + tDist*0.7, y - tDist*0.7, tSize, 0, Math.PI*2); ctx.fill();
        };

        const endGame = () => {
            gameState.isPlaying = false;
            cancelAnimationFrame(animationFrameId);
            
            setTimeout(() => {
                // Update UI
                ui.startScreen.style.display = 'none';
                ui.gameOverScreen.style.display = 'flex';

                ui.finalScore.innerText = gameState.score;
                ui.maxCombo.innerText = gameState.maxCombo;

                const maxPossibleScore = gameState.notes.length * 100;
                const pct = maxPossibleScore > 0 ? gameState.score / maxPossibleScore : 0;

                let rank = "Stray Cat";
                if (pct > 0.9) rank = "Pop Star Purrfection!";
                else if (pct > 0.7) rank = "Cool Cat";
                else if (pct > 0.5) rank = "House Cat";
                
                ui.rankText.innerText = rank;
            }, 1000);
        };

        // --- Game Loop (Updated Canvas BG) ---
        const gameLoop = () => {
            if (!gameState.isPlaying || !ctx || !canvas || !audioEngine) {
                 // Keep loop alive for effects outside of playing state
                 animationFrameId = requestAnimationFrame(gameLoop);
                 return;
            }

            const AE = audioEngine;
            const audioTime = AE.getCurrentTime();
            const gameTime = audioTime - gameState.startTime;
            const laneWidth = canvas.width / gameState.laneCount;
            const hitZoneTop = gameState.hitY;
            
            // Clear & BG (Light Pink/White Gradient for canvas)
            const grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grd.addColorStop(0, "#FFFFFF");
            grd.addColorStop(1, "#FFE4E1"); 
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Update Lyrics
            gameState.lyrics.forEach(lyric => {
                if (!lyric.shown && gameTime >= lyric.time) {
                    lyric.shown = true;
                    ui.lyricsContainer.innerHTML = `<div class="lyric-line lyric-active">${lyric.text}</div>`;
                }
            });

            // Draw Lanes
            for (let i = 0; i < gameState.laneCount; i++) {
                // Gradient Lane (Very subtle white)
                const laneGrd = ctx.createLinearGradient(0, 0, 0, canvas.height);
                laneGrd.addColorStop(0, "rgba(255,255,255,0)");
                laneGrd.addColorStop(1, "rgba(255,255,255,0.1)");
                ctx.fillStyle = laneGrd;
                ctx.fillRect(i * laneWidth, 0, laneWidth, canvas.height);
                
                // Separator (Darker for visibility)
                ctx.strokeStyle = "rgba(90, 24, 154, 0.2)"; /* Dark Purple separator */
                ctx.beginPath(); ctx.moveTo(i*laneWidth, 0); ctx.lineTo(i*laneWidth, canvas.height); ctx.stroke();

                // --- Draw the fixed Hit Target ZONE (The "Cat's Arm") ---
                const targetHeight = canvas.height - hitZoneTop;
                const xCenter = i * laneWidth + laneWidth / 2;

                // 1. Draw the static target zone background
                ctx.fillStyle = "rgba(236, 72, 153, 0.15)"; /* Pink tint */
                ctx.fillRect(i * laneWidth, hitZoneTop, laneWidth, targetHeight);

                // 2. Draw the highlight (the "hit" visual)
                if (activeLanes[i]) {
                    ctx.fillStyle = LANE_COLORS[i];
                    ctx.fillRect(i * laneWidth, hitZoneTop, laneWidth, targetHeight);
                    
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = LANE_COLORS[i];
                    
                    // Draw a static, subtle paw inside the hit zone (using contrasting color)
                    ctx.save();
                    ctx.translate(xCenter, hitZoneTop + targetHeight / 2);
                    drawPaw(ctx, 0, 0, 25, 'rgba(90, 24, 154, 0.8)');
                    ctx.restore();
                }
                
                ctx.shadowBlur = 0;
                
                // 3. Draw a strong line/border at the strike position (top of the arm)
                ctx.strokeStyle = activeLanes[i] ? "#000" : LANE_COLORS[i]; /* Black line on hit */
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.moveTo(i * laneWidth, hitZoneTop);
                ctx.lineTo((i + 1) * laneWidth, hitZoneTop);
                ctx.stroke();
            }

            let allNotesFinished = true;

            // Draw & Update Notes
            gameState.notes.forEach(note => {
                const timeDiff = note.time - gameTime;
                const y = hitZoneTop - (timeDiff * gameState.speed);

                // Auto-play audio (The Meow)
                if (timeDiff <= 0 && !note.played) {
                    AE.playMeow(note.freq); 
                    note.played = true;
                }

                // Miss Logic (Note passes the bottom of the visible area/arm)
                if (y > canvas.height + 50 && !note.hit && !note.missed) {
                    note.missed = true;
                    note.visible = false;
                    gameState.combo = 0;
                    updateScoreboard();
                    createFloatingText("Hiss", note.lane * laneWidth + laneWidth/2, hitZoneTop + 50, "#5A189A"); /* Dark Hiss text */
                    AE.playHitSound('miss');
                }

                // Draw Item (Emoji)
                if (note.visible && y > -50 && y < canvas.height + 50) {
                    allNotesFinished = false;
                    const x = note.lane * laneWidth + laneWidth / 2;
                    const item = LANE_ITEMS[note.lane];

                    // --- Item Styling: Maximum Glow against light BG ---
                    ctx.font = '60px sans-serif'; 
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // Set full brightness and a stronger shadow/glow
                    ctx.shadowColor = LANE_COLORS[note.lane]; // Color the glow based on the lane color
                    ctx.shadowBlur = 15; 
                    
                    ctx.globalAlpha = 1.0; 
                    ctx.fillText(item, x, y); 
                    ctx.globalAlpha = 1.0; 

                    ctx.shadowBlur = 0; 
                } else if (!note.missed && !note.hit && note.time > gameTime) {
                    allNotesFinished = false;
                }
            });

            // Particles
            for (let i = gameState.particles.length - 1; i >= 0; i--) {
                const p = gameState.particles[i];
                p.x += p.vx; p.y += p.vy; p.vy += 0.8; p.life -= 0.04;
                ctx.globalAlpha = Math.max(0, p.life);
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
                if (p.life <= 0) gameState.particles.splice(i, 1);
            }

            // Paw Stamps 
            for (let i = pawStamps.length - 1; i >= 0; i--) {
                const stamp = pawStamps[i];
                stamp.life -= 0.03; 
                
                if (stamp.life <= 0) {
                    pawStamps.splice(i, 1);
                    continue;
                }

                const laneX = stamp.lane * laneWidth;
                
                // --- 1. Draw the Extended Hit Trail (The "Long Paw Stamp") ---
                ctx.globalAlpha = Math.max(0, stamp.life * 0.7); 
                ctx.fillStyle = stamp.color;
                ctx.fillRect(laneX, hitZoneTop, laneWidth, canvas.height - hitZoneTop);
                
                ctx.globalAlpha = 1; 

                // --- 2. Draw the Paw Icon at the strike point (middle of the hit zone) ---
                ctx.save();
                ctx.globalAlpha = Math.max(0, stamp.life); 
                ctx.translate(stamp.x, stamp.y);
                ctx.rotate(stamp.rotation);
                
                if (pawImage.complete) {
                    const imgSize = stamp.size;
                    ctx.filter = `drop-shadow(0 0 5px ${stamp.color})`; /* Paw shadow in stamp color */
                    ctx.drawImage(pawImage, -imgSize / 2, -imgSize / 2, imgSize, imgSize);
                }

                ctx.filter = 'none'; 
                ctx.globalAlpha = 1;
                ctx.restore();
            }


            // Floating Text
            for (let i = floatingTexts.length - 1; i >= 0; i--) {
                const ft = floatingTexts[i];
                ft.y -= 2; ft.life -= 0.03;
                
                if (ft.life <= 0) {
                    floatingTexts.splice(i, 1);
                    continue;
                }

                ctx.globalAlpha = Math.max(0, ft.life);
                ctx.save();
                ctx.translate(ft.x, ft.y);
                const scale = 1 + (1-ft.life)*0.5;
                ctx.scale(scale, scale);
                ctx.fillStyle = ft.color;
                ctx.font = "bold 30px 'Fredoka One'";
                ctx.textAlign = "center";
                ctx.strokeStyle = "black";
                ctx.lineWidth = 3;
                ctx.strokeText(ft.text, 0, 0);
                ctx.fillText(ft.text, 0, 0);
                ctx.restore();
                ctx.globalAlpha = 1;
            }

            if (allNotesFinished && gameState.notes.length > 0) {
                if (gameTime > gameState.notes[gameState.notes.length-1].time + 1.5) {
                    endGame();
                    return;
                }
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        };

        // --- Input Handling (Unchanged) ---

        const handleInput = (lane) => {
            if (!gameState.isPlaying || !audioEngine) return;

            // Visual feedback
            activeLanes[lane] = true;
            setTimeout(() => { activeLanes[lane] = false; }, 100);

            const AE = audioEngine;
            const gameTime = AE.getCurrentTime() - gameState.startTime;
            const laneWidth = canvas.width / gameState.laneCount;
            const x = lane * laneWidth + laneWidth / 2;
            const yStamp = gameState.hitY + 50; // Center of the 100px hit zone

            createPawStamp(lane, x, yStamp, LANE_COLORS[lane]); 

            const candidates = gameState.notes.filter(n => 
                // Check if note is in the hit zone (time +/- 0.35s)
                n.lane === lane && !n.hit && !n.missed && Math.abs(n.time - gameTime) < 0.35
            );

            if (candidates.length > 0) {
                const note = candidates[0];
                const diff = Math.abs(note.time - gameTime);
                note.hit = true;
                note.visible = false;
                
                let txt = "", col = "";
                let scoreDelta = 0;
                let comboDelta = 0;

                // Floating text colors adjusted for light background
                if (diff < 0.1) {
                    txt = "PURRFECT!"; col = "#EC4899"; scoreDelta = 100 + (gameState.combo*5); /* Bright Pink */
                    comboDelta = 1;
                    AE.playHitSound('perfect');
                } else if (diff < 0.25) {
                    txt = "Good!"; col = "#3B82F6"; scoreDelta = 50 + (gameState.combo*2); /* Bright Blue */
                    comboDelta = 1;
                    AE.playHitSound('good');
                } else {
                    txt = "Meh"; col = "#5A189A"; scoreDelta = 10; /* Dark Purple */
                    comboDelta = -gameState.combo;
                    AE.playHitSound('meh');
                }

                gameState.combo = Math.max(0, gameState.combo + comboDelta);
                gameState.score += scoreDelta;
                
                if (gameState.combo > gameState.maxCombo) {
                    gameState.maxCombo = gameState.combo;
                }
                
                updateScoreboard();

                // Floating text starts near the top of the hit zone
                createFloatingText(txt, x, gameState.hitY - 30, col);
                spawnParticles(x, gameState.hitY + 50, LANE_COLORS[lane]);
            }
        };

        const handleKey = (e) => {
            if (keyMap.hasOwnProperty(e.code)) handleInput(keyMap[e.code]);
        };
        const handleTouch = (e) => {
            if (!gameState.isPlaying) return;
            e.preventDefault();
            const canvasRect = canvas.getBoundingClientRect();
            for (let i = 0; i < e.changedTouches.length; i++) {
                const x = e.changedTouches[i].clientX - canvasRect.left;
                // REMOVED Y-check: Allow tapping anywhere in the lane for better playability
                const lane = Math.floor(x / (canvasRect.width / 4));
                if (lane >= 0 && lane < 4) handleInput(lane);
            }
        };
        const handleMouse = (e) => {
            if (!gameState.isPlaying) return;
            const canvasRect = canvas.getBoundingClientRect();
            const x = e.clientX - canvasRect.left;
            // REMOVED Y-check: Allow clicking anywhere in the lane
            const lane = Math.floor(x / (canvasRect.width / 4));
            if (lane >= 0 && lane < 4) handleInput(lane);
        };
        
        // --- Game Flow Functions (Unchanged) ---

        const parseSong = (songId) => {
            const song = SONGS[songId];
            if (!song) return { notes: [], lyrics: [] };

            const beatTime = 60 / song.bpm;
            let currentNoteTime = 2.0;

            const gameNotes = song.notes
                .map((n, index) => {
                    // Robustness check: Ensure n is a valid note structure (e.g., ['C4', 1])
                    if (!n || typeof n[0] !== 'string' || typeof n[1] !== 'number' || n[1] <= 0) {
                        return null; // Skip invalid entries
                    }
                    
                    const freq = NOTE_FREQS[n[0]];
                    const duration = n[1];
                    let lane = index % 4;
                    
                    // --- Simple Lane Assignment Heuristic ---
                    if (index % 3 === 0) lane = (lane + 1) % 4;
                    // Assign higher notes to the rightmost lane (3) for difficulty
                    if (n[0].indexOf('5') > -1 || n[0].indexOf('6') > -1) lane = 3; 
                    // Assign lower notes to the leftmost lane (0) for contrast
                    if (n[0].indexOf('2') > -1) lane = 0; 
                    // --- End Heuristic ---

                    const noteObj = {
                        time: currentNoteTime,
                        lane: lane,
                        freq: freq,
                        duration: duration * beatTime,
                        played: false, hit: false, missed: false, visible: true
                    };
                    currentNoteTime += duration * beatTime;
                    return noteObj;
                })
                .filter(n => n !== null); // Filter out any nulls from invalid note entries

            const gameLyrics = song.lyrics ? song.lyrics.map(l => ({
                time: 2.0 + (l.beat * beatTime),
                text: l.text,
                shown: false
            })) : [];

            return { notes: gameNotes, lyrics: gameLyrics };
        };


        const startGame = () => {
            if (!audioEngine || !audioEngine.isLoaded()) return;
            
            audioEngine.playUISound();
            audioEngine.init();
            
            const selectedSongId = ui.songSelect.value;
            const songData = parseSong(selectedSongId);
            
            gameState = {
                isPlaying: true,
                startTime: audioEngine.getCurrentTime(),
                score: 0,
                combo: 0,
                maxCombo: 0,
                notes: songData.notes,
                lyrics: songData.lyrics,
                particles: [],
                laneCount: 4, 
                speed: 500, 
                hitY: gameState.hitY,
            };
            
            floatingTexts = [];
            pawStamps = [];

            updateScoreboard();
            
            // Hide start screen, show game
            ui.startScreen.style.display = 'none';
            ui.lyricsContainer.innerHTML = '<div class="lyric-line lyric-active">Ready...</div>';

            cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(gameLoop);
        };

        const restartGame = () => {
            audioEngine?.playUISound();
            // Hide game over screen, show start screen
            ui.gameOverScreen.style.display = 'none';
            ui.startScreen.style.display = 'flex';
        };

        const shareScore = () => {
            audioEngine?.playUISound();
            
            const originalText = ui.shareBtn.innerText;
            
            const finalRankText = ui.rankText.innerText || "Stray Cat";
            const text = `I scored ${gameState.score} points (${finalRankText}) on I-mog-en: The Mewsical! Can you beat my combo of ${gameState.maxCombo}? ðŸ±ðŸŽµ`;
            
            const restoreButton = (newText, duration = 2000) => {
                ui.shareBtn.innerText = newText;
                setTimeout(() => ui.shareBtn.innerText = originalText, duration);
            };

            if (navigator.share) {
                navigator.share({
                    title: 'I-mog-en: The Mewsical',
                    text: text,
                    url: window.location.href
                }).catch(error => {
                    if (error.name !== 'AbortError') restoreButton("Sharing Failed", 3000);
                });
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = 'fixed'; 
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    restoreButton("Copied to Clipboard!", 2500); 
                } catch (err) {
                    restoreButton("Copy Failed", 3000);
                } finally {
                    document.body.removeChild(textArea);
                }
            }
        };



        // --- Initialization on Load (Unchanged) ---
        window.onload = function () {
            initUI();
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // Initialize basic game state defaults
            gameState = {
                isPlaying: false, startTime: 0, score: 0, combo: 0, maxCombo: 0,
                notes: [], lyrics: [], particles: [], laneCount: 4, speed: 500, hitY: 0,
            };
            
            resize();
            initAudioEngine();

            // Setup Event Listeners
            window.addEventListener('resize', resize);
            window.addEventListener('keydown', handleKey);
            canvas.addEventListener('touchstart', handleTouch, {passive: false}); 
            canvas.addEventListener('mousedown', handleMouse);
            ui.startBtn.addEventListener('click', startGame);
            ui.restartBtn.addEventListener('click', restartGame);
            ui.shareBtn.addEventListener('click', shareScore);

            // Start the main loop (keeps effects alive even if not playing)
            animationFrameId = requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
