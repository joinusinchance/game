<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Cribbage Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .container {
            max-width: 420px;
            width: 100%;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 15px 0 rgba(0, 0, 0, 0.05);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Blue 600 */
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary {
            background-color: #fcd34d; /* Amber 300 */
            color: #333;
        }
        .btn-secondary:hover {
            background-color: #fbbf24; /* Amber 400 */
        }
        .message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
            max-width: 90%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .message-box.success {
            background-color: #10b981; /* Green 500 */
            color: white;
        }
        .message-box.error {
            background-color: #ef4444; /* Red 500 */
            color: white;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Multiplayer Cribbage Setup</h1>

    <!-- Authentication Status -->
    <div id="authStatus" class="mb-4 text-sm p-2 bg-gray-100 rounded-lg">
        Loading...
    </div>

    <!-- UI States -->
    <div id="gameSetup" class="space-y-4">
        <h2 class="text-xl font-bold mb-3 text-gray-700">Start or Join Game</h2>
        <input type="text" id="gameIdInput" placeholder="Enter Game ID (e.g., GAME123)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        
        <div class="flex flex-col space-y-3">
            <button id="createGameBtn" class="btn btn-primary">Create New Game</button>
            <button id="joinGameBtn" class="btn btn-secondary">Join Game</button>
        </div>
    </div>

    <div id="gameLobby" class="hidden space-y-4">
        <h2 class="text-xl font-bold text-gray-700">Game Lobby: <span id="lobbyGameId" class="text-blue-600"></span></h2>
        <p class="text-gray-600">Share this ID with the second player to start the game!</p>
        <p id="playerStatus" class="text-lg font-semibold text-center p-3 rounded-lg bg-yellow-100 text-yellow-800"></p>
        <button id="leaveLobbyBtn" class="btn w-full bg-gray-400 text-white hover:bg-gray-500">Leave Lobby</button>
    </div>

    <div id="gamePlay" class="hidden space-y-4">
        <h2 class="text-xl font-bold text-gray-700">Game In Progress: <span id="playGameId" class="text-blue-600"></span></h2>
        <div id="gameDataDisplay" class="p-4 bg-gray-50 rounded-lg border">
            <!-- Real-time game state will appear here -->
            <p>Waiting for game state...</p>
        </div>
    </div>
</div>

<div id="messageContainer"></div>

<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, deleteDoc, Timestamp, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global Firebase variables
    let app, db, auth;
    let userId = null;
    let currentGameId = null;
    let unsubscribeGame = null; // For the real-time listener

    // =========================================================================
    // !!! CRITICAL: REPLACE THESE PLACEHOLDERS WITH YOUR ACTUAL FIREBASE CONFIG !!!
    // If you are hosting this file outside of the development environment,
    // this object MUST contain your project details.
    // =========================================================================
 /*   const EXTERNAL_FIREBASE_CONFIG = {
        apiKey: "YOUR_API_KEY_HERE", // <-- REQUIRED
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID", // <-- REQUIRED
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    };
*/

  const EXTERNAL_FIREBASE_CONFIG = {
    apiKey: "AIzaSyB-BW4jCwRVJN64f_ZSB_UfUL6p1lo6lvY",
    authDomain: "util-ce85f.firebaseapp.com",
    projectId: "util-ce85f",
    storageBucket: "util-ce85f.firebasestorage.app",
    messagingSenderId: "654619024656",
    appId: "1:654619024656:web:cdc7cf569edf739ee05995",
    measurementId: "G-ZZ8S4H0XPW"
  };




    
    // --- Configuration and Initialization ---

    // 1. Determine the appropriate Firebase configuration
    let firebaseConfig = null;
    let appId = 'default-app-id';
    let initialAuthToken = null;

    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
        // Running inside the development environment (Canvas)
        console.log("Using Canvas provided configuration.");
        firebaseConfig = JSON.parse(__firebase_config);
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    } else if (EXTERNAL_FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY_HERE") {
        // Running on an external host with user-provided configuration
        console.log("Using external configuration.");
        firebaseConfig = EXTERNAL_FIREBASE_CONFIG;
        // In external hosting, we use the projectId as the unique app identifier 
        // since the Canvas __app_id is unavailable.
        appId = firebaseConfig.projectId || 'external-host-app-id'; 
        // We cannot use __initial_auth_token externally, so it stays null.
        initialAuthToken = null; 
    } else {
        console.error("Firebase configuration is completely missing.");
    }


    // Show custom message box instead of alert()
    function showMessageBox(message, type = 'success') {
        const container = document.getElementById('messageContainer');
        const box = document.createElement('div');
        box.className = `message-box ${type}`;
        box.textContent = message;
        container.appendChild(box);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            box.remove();
        }, 5000);
    }

    // Initialize Firebase and Authentication
    async function initApp() {
        if (!firebaseConfig || !firebaseConfig.apiKey) {
            console.error("Firebase configuration is missing or invalid.");
            document.getElementById('authStatus').textContent = 'Error: Firebase config missing. Please set EXTERNAL_FIREBASE_CONFIG.';
            showMessageBox('Configuration error. Cannot connect to database.', 'error');
            return;
        }

        // Enable debug logging for Firestore
        setLogLevel('Debug'); 

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication using custom token (Canvas) or anonymous sign-in (External)
            if (initialAuthToken) {
                // Use custom token if provided (Canvas environment)
                await signInWithCustomToken(auth, initialAuthToken);
                console.log("Signed in with custom token.");
            } else {
                // Fallback to anonymous sign-in (External environment)
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            }

            // Listen for auth state change to set the userId
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('authStatus').innerHTML = `User ID: <span class="font-mono text-xs p-1 bg-gray-200 rounded">${userId}</span>`;
                    
                    // After successful authentication, run cleanup
                    cleanupOldGames(db, appId);

                } else {
                    userId = null;
                    document.getElementById('authStatus').textContent = 'Status: Not authenticated.';
                }
            });

        } catch (error) {
            console.error("Firebase Initialization or Auth Error:", error);
            document.getElementById('authStatus').textContent = `Auth Error: ${error.message}`;
            showMessageBox('Authentication failed.', 'error');
        }
    }

    // --- Database Cleanup Logic ---

    /**
     * Deletes game documents older than 1 hour.
     * Must be called only after Firebase is initialized and authenticated.
     */
    async function cleanupOldGames(db, appId) {
        // 3,600,000 milliseconds = 1 hour
        const cutoff = Timestamp.fromMillis(Date.now() - 3600000); 
        // Path adjusted to use the determined appId
        const gamesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');

        console.log(`[Cleanup] Checking for games older than: ${cutoff.toDate().toLocaleString()}`);

        try {
            // Query for documents where 'createdAt' is older than the cutoff timestamp
            const q = query(
                gamesCollectionRef,
                where('createdAt', '<', cutoff)
            );

            const snapshot = await getDocs(q);
            const deletionPromises = [];

            console.log(`[Cleanup] Found ${snapshot.docs.length} old games to delete.`);

            snapshot.docs.forEach((doc) => {
                deletionPromises.push(deleteDoc(doc.ref));
                console.log(`[Cleanup] Scheduling deletion for Game ID: ${doc.id}`);
            });

            await Promise.all(deletionPromises);
            if (snapshot.docs.length > 0) {
                showMessageBox(`Cleaned up ${snapshot.docs.length} abandoned game(s) from the last hour.`, 'success');
            }

        } catch (error) {
            console.error("Error during game cleanup (Ensure index for 'createdAt' exists if required):", error);
            showMessageBox('Could not perform database cleanup.', 'error');
        }
    }


    // --- Game State Management ---

    function setUiState(state) {
        document.getElementById('gameSetup').classList.add('hidden');
        document.getElementById('gameLobby').classList.add('hidden');
        document.getElementById('gamePlay').classList.add('hidden');

        if (state === 'setup') {
            document.getElementById('gameSetup').classList.remove('hidden');
        } else if (state === 'lobby') {
            document.getElementById('gameLobby').classList.remove('hidden');
        } else if (state === 'play') {
            document.getElementById('gamePlay').classList.remove('hidden');
        }
    }

    function resetGame() {
        if (unsubscribeGame) {
            unsubscribeGame();
            unsubscribeGame = null;
        }
        currentGameId = null;
        setUiState('setup');
        document.getElementById('gameIdInput').value = '';
    }

    // --- Firebase Interactions ---

    async function createGame() {
        if (!userId) {
            showMessageBox('Authentication not complete. Please wait.', 'error');
            return;
        }

        const gameId = document.getElementById('gameIdInput').value.trim().toUpperCase() || crypto.randomUUID().substring(0, 6).toUpperCase();
        currentGameId = gameId;
        const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);

        try {
            const docSnap = await getDoc(gameDocRef);

            if (docSnap.exists()) {
                showMessageBox(`Game ID ${gameId} already exists. Please try joining or use a new ID.`, 'error');
                return;
            }

            // Create the game document with necessary initial data and a timestamp
            await setDoc(gameDocRef, {
                player1Id: userId,
                status: 'waiting', // Waiting for P2
                turn: 'P1',
                score: { P1: 0, P2: 0 },
                log: [`Game created by ${userId}`],
                createdAt: Timestamp.now(), // Save creation time for cleanup
            });

            setupGameListener(gameId);
            document.getElementById('lobbyGameId').textContent = gameId;
            showMessageBox(`Game ${gameId} created! Waiting for P2.`, 'success');

        } catch (error) {
            console.error("Error creating game:", error);
            showMessageBox(`Error creating game: ${error.message}`, 'error');
        }
    }

    async function joinGame() {
        if (!userId) {
            showMessageBox('Authentication not complete. Please wait.', 'error');
            return;
        }

        const gameId = document.getElementById('gameIdInput').value.trim().toUpperCase();
        if (!gameId) {
            showMessageBox('Please enter a Game ID to join.', 'error');
            return;
        }
        currentGameId = gameId;
        const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);

        try {
            const docSnap = await getDoc(gameDocRef);

            if (!docSnap.exists()) {
                showMessageBox(`Game ID ${gameId} not found.`, 'error');
                return;
            }

            const gameData = docSnap.data();

            if (gameData.status !== 'waiting') {
                showMessageBox(`Game ${gameId} is already in progress or full.`, 'error');
                return;
            }

            // Join the game as Player 2
            await setDoc(gameDocRef, {
                player2Id: userId,
                status: 'ready', // Game starts
                log: [...gameData.log, `${userId} joined the game. Game is ready!`]
            }, { merge: true }); // Use merge to update existing fields

            setupGameListener(gameId);
            document.getElementById('lobbyGameId').textContent = gameId;
            showMessageBox(`Joined game ${gameId} successfully!`, 'success');

        } catch (error) {
            console.error("Error joining game:", error);
            showMessageBox(`Error joining game: ${error.message}`, 'error');
        }
    }
    
    // --- Real-time Listener and UI Update ---

    function setupGameListener(gameId) {
        if (unsubscribeGame) {
            unsubscribeGame(); // Stop previous listener if any
        }
        
        const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);

        // Set up the real-time listener
        unsubscribeGame = onSnapshot(gameDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const gameData = docSnap.data();
                updateGameUI(gameData);
            } else {
                // Game document was deleted
                showMessageBox(`Game ${gameId} was deleted or abandoned.`, 'error');
                resetGame();
            }
        }, (error) => {
            console.error("Error listening to game changes:", error);
            showMessageBox("Connection error: Could not listen for real-time updates.", 'error');
        });
    }

    function updateGameUI(data) {
        const gameId = currentGameId;
        const isPlayer1 = data.player1Id === userId;
        const isPlayer2 = data.player2Id === userId;

        if (data.status === 'waiting') {
            setUiState('lobby');
            document.getElementById('playerStatus').textContent = isPlayer1 
                ? 'You are Player 1. Waiting for Player 2 to join...'
                : 'You are attempting to join a lobby (Should only happen if you are P1)';
        } else if (data.status === 'ready' || data.status === 'in-progress') {
            setUiState('play');
            document.getElementById('playGameId').textContent = gameId;
            
            // Determine player roles
            const myRole = isPlayer1 ? "Player 1" : (isPlayer2 ? "Player 2" : "Spectator");
            
            // Build the dynamic display content
            let displayContent = `<p class="font-bold mb-3">Your Role: ${myRole}</p>`;
            displayContent += `<p><strong>P1 (${data.player1Id}):</strong> ${data.score.P1} points</p>`;
            displayContent += `<p><strong>P2 (${data.player2Id || 'N/A'}):</strong> ${data.score.P2} points</p>`;
            displayContent += `<p><strong>Status:</strong> ${data.status}</p>`;
            displayContent += `<p><strong>Current Turn:</strong> ${data.turn}</p>`;
            
            displayContent += `<div class="mt-4 border-t pt-2">
                <p class="font-semibold">Game Log:</p>
                <ul class="text-sm max-h-24 overflow-y-auto bg-white p-2 rounded">${data.log.map(entry => `<li>- ${entry}</li>`).join('')}</ul>
            </div>`;

            document.getElementById('gameDataDisplay').innerHTML = displayContent;
        }
    }
    
    // Function to handle leaving the lobby (deleting the game)
    async function leaveLobby() {
        if (!currentGameId || !userId) return;

        const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId);
        
        try {
             const docSnap = await getDoc(gameDocRef);
             if (docSnap.exists() && docSnap.data().player1Id === userId) {
                 // Only P1 can delete the game in the lobby stage
                 await deleteDoc(gameDocRef);
                 showMessageBox(`Game ${currentGameId} successfully deleted.`, 'success');
             } else {
                 showMessageBox('You do not have permission to delete this game or the game has moved past the lobby stage.', 'error');
             }
        } catch (error) {
            console.error("Error deleting game:", error);
            showMessageBox('Failed to delete game document.', 'error');
        } finally {
            resetGame();
        }
    }


    // --- Event Listeners ---
    document.getElementById('createGameBtn').addEventListener('click', createGame);
    document.getElementById('joinGameBtn').addEventListener('click', joinGame);
    document.getElementById('leaveLobbyBtn').addEventListener('click', leaveLobby);
    
    // Start the app when the window loads
    window.onload = initApp;

</script>
</body>
</html>
